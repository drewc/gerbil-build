<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-07-28 Tue 19:10 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Building Gerbil Packages</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Building Gerbil Packages</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgb3d369c"><code>make.ss</code>: the maker of makefiles</a></li>
<li><a href="#orge7bea10"><code>/make/gxc</code> Compile to a made library</a>
<ul>
<li><a href="#orgebe0a36">Step 1: Compile a file to a library</a>
<ul>
<li><a href="#org8ea47cd">No package?</a></li>
</ul>
</li>
<li><a href="#org771b13b">Step 2: Crib <code>gxc-compile</code> from Fare</a>
<ul>
<li><a href="#org95b4601">The Struct</a></li>
<li><a href="#gxc_outputs_begin"><code>gxc-outputs</code>: the end of the beginning</a></li>
<li><a href="#org703bf43">Break into modules</a></li>
<li><a href="#org669cb50"><code>mod</code>'s: Talking 'bout this generation</a></li>
<li><a href="#org11f5adf"><code>gxc-compile-file</code>: `make;make install`</a></li>
<li><a href="#orgaaf1637">bootstrap</a></li>
</ul>
</li>
<li><a href="#org75674b0">Step 3: Release pre-0.1 build</a></li>
<li><a href="#org72d8d62">Step 4: Test the new <code>make/script</code></a></li>
<li><a href="#orga1e2be7">Step 5: Publish Documentation</a></li>
</ul>
</li>
<li><a href="#orged8d92a">Appendicitis</a></li>
</ul>
</div>
</div>
<blockquote>
<p>
Drew Crampsie @drewc 14:28
</p>

<p>
Ok, dammit, I have so been trying to avoid becoming a major gerbil contributor
but I think that was self-deprecation mixed with lazy stoner who is overworked
somewhat already lol &#x2026; not understanding that it saves time and effort to save
time and effort &#x2026; silly man.
</p>
</blockquote>


<p>
How things are built matters. In order to save time and effort we do not want to
rebuild everything each character change. At the same time, we want to be
liberal and not enforce a style or layout upon developers.
</p>


<div id="outline-container-orgb3d369c" class="outline-2">
<h2 id="orgb3d369c"><code>make.ss</code>: the maker of makefiles</h2>
<div class="outline-text-2" id="text-orgb3d369c">
<p>
It seems that there is one <a href="https://github.com/vyzo/gerbil/blob/master/src/std/make.ss">middleman</a> that acts as a go between. There is a
<a href="https://github.com/vyzo/gerbil/blob/master/doc/reference/make.md">reference</a> on it, and a <a href="https://github.com/vyzo/gerbil/blob/master/doc/guide/build.md">guide</a> on building as well. I suppose these things are
important to developers!
</p>


<p>
Using the reference we'll literately re-create the middleman and document/test
in the guide?
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #4f97d7;">cd</span> ~/src/gerbil-build/doc/
cp ~/src/gerbil/doc/reference/make.md .
pandoc -o make.org make.md
</pre>
</div>

<p>
Perhaps. For now we'll simple inline things as the thoughts spring up.
</p>
</div>
</div>


<div id="outline-container-orge7bea10" class="outline-2">
<h2 id="orge7bea10"><code>/make/gxc</code> Compile to a made library</h2>
<div class="outline-text-2" id="text-orge7bea10">
</div>
<div id="outline-container-orgebe0a36" class="outline-3">
<h3 id="orgebe0a36">Step 1: Compile a file to a library</h3>
<div class="outline-text-3" id="text-orgebe0a36">
<p>
Let us create a file, compile to the right spot, and run it.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #4f97d7;">package:</span> drewc
(<span style="color: #4f97d7; font-weight: bold;">export</span> hello)

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">hello</span>) <span style="color: #2d9574;">"Hello World"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:gerbil/compiler</span> <span style="color: #4f97d7;">:std/srfi/13</span>)
<span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">(export #t)</span>

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">gerbil-path</span> (getenv <span style="color: #2d9574;">"GERBIL_PATH"</span> <span style="color: #2d9574;">"~/.gerbil"</span>))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">libdir</span> (string-append gerbil-path <span style="color: #2d9574;">"/lib"</span>))
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">module-package</span> ctx)
  (<span style="color: #4f97d7; font-weight: bold;">let</span> (id (symbol-&gt;string (gx<span style="color: #4f97d7;">#</span>expander-context-id ctx)))
    (<span style="color: #4f97d7; font-weight: bold;">cond</span> ((string-rindex id <span style="color: #4f97d7;">#</span>\/)
           <span style="color: #4f97d7;">=&gt;</span> (<span style="color: #4f97d7; font-weight: bold;">lambda</span> (x) (substring id 0 x)))
          (<span style="color: #4f97d7;">#t</span> <span style="color: #2d9574;">""</span>))))
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">ss-file-libdir</span> file)
  (string-append libdir <span style="color: #2d9574;">"/"</span> (module-package (gx<span style="color: #4f97d7;">#</span>import-module file))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">make-ss</span> file)
    (compile-file file
                  <span style="color: #7590db;">[</span><span style="color: #4f97d7;">output-dir:</span>
                   libdir
                   <span style="color: #4f97d7;">invoke-gsc:</span> <span style="color: #4f97d7;">#t</span>
                <span style="color: #2aa1ae; background-color: #292e34;">;   </span><span style="color: #2aa1ae; background-color: #292e34;">keep-scm: #f</span>
                 <span style="color: #2aa1ae; background-color: #292e34;">;  </span><span style="color: #2aa1ae; background-color: #292e34;">generate-ssxi: #t</span>
                   <span style="color: #4f97d7;">verbose:</span> <span style="color: #4f97d7;">#t</span>
                   <span style="color: #7590db;">]</span>))

</pre>
</div>

<p>
Test it out.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:drewc/hello</span> <span style="color: #4f97d7;">:std/test</span>)
(check (hello) <span style="color: #4f97d7;">=&gt;</span> <span style="color: #2d9574;">"Hello World"</span>)

</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">rm ~/.gerbil/lib/drewc/hello*
gxi -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/make1.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(make-ss "~/src/gerbil-build/test/hello.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/test-hello.ss")'</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">compile ~/src/gerbil-build/test/hello.ss
compile drewc/hello
compile ~/.gerbil/lib/drewc/hello__0.scm
invoke gsc <span style="color: #4f97d7;">(</span>gsc -:i8,f8,-8,t8 ~/.gerbil/lib/drewc/hello__0.scm<span style="color: #4f97d7;">)</span>
compile ~/.gerbil/lib/drewc/hello__rt.scm
invoke gsc <span style="color: #4f97d7;">(</span>gsc -:i8,f8,-8,t8 ~/.gerbil/lib/drewc/hello__rt.scm<span style="color: #4f97d7;">)</span>
compile ~/.gerbil/lib/drewc/hello.ssi
... check <span style="color: #4f97d7;">(</span>hello<span style="color: #4f97d7;">)</span> is equal? to <span style="color: #2d9574;">"Hello World"</span>
</pre>
</div>
</div>



<div id="outline-container-org8ea47cd" class="outline-4">
<h4 id="org8ea47cd">No package?</h4>
<div class="outline-text-4" id="text-org8ea47cd">
<p>
What happens if it has no package?
</p>
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">export</span> hello)

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">hello</span>) <span style="color: #2d9574;">"Hello World... NOT!"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:hello-no-package</span> <span style="color: #4f97d7;">:std/test</span>)
(check (hello) <span style="color: #4f97d7;">=&gt;</span> <span style="color: #2d9574;">"Hello World... NOT!"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">rm ~/.gerbil/lib/hello-no-package*
gxi -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/make1.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(make-ss "~/src/gerbil-build/test/hello-no-package.ss")'</span><span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/test-hello-no-package.ss")'</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">compile ~/src/gerbil-build/test/hello-no-package.ss
compile hello-no-package
compile ~/.gerbil/lib/hello-no-package__0.scm
invoke gsc <span style="color: #4f97d7;">(</span>gsc -:i8,f8,-8,t8 ~/.gerbil/lib/hello-no-package__0.scm<span style="color: #4f97d7;">)</span>
compile ~/.gerbil/lib/hello-no-package__rt.scm
invoke gsc <span style="color: #4f97d7;">(</span>gsc -:i8,f8,-8,t8 ~/.gerbil/lib/hello-no-package__rt.scm<span style="color: #4f97d7;">)</span>
compile ~/.gerbil/lib/hello-no-package.ssi
... check <span style="color: #4f97d7;">(</span>hello<span style="color: #4f97d7;">)</span> is equal? to <span style="color: #2d9574;">"Hello World... NOT!"</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org771b13b" class="outline-3">
<h3 id="org771b13b">Step 2: Crib <code>gxc-compile</code> from Fare</h3>
<div class="outline-text-3" id="text-org771b13b">
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:gerbil/compiler</span> <span style="color: #4f97d7;">:std/misc/path</span> <span style="color: #4f97d7;">:std/misc/list</span>
      <span style="color: #4f97d7;">:std/misc/concurrent-plan</span>)
</pre>
</div>
</div>

<div id="outline-container-org95b4601" class="outline-4">
<h4 id="org95b4601">The Struct</h4>
<div class="outline-text-4" id="text-org95b4601">
<p>
We need a <code>settings</code> struct to start off with. We'll make it almost identical
save for renaming <code>prefix</code> to <code>package</code>.
</p>

<div class="org-src-container">
<pre class="src src-scheme"> <span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">Settings: see details in doc/reference/make.md</span>
 (<span style="color: #4f97d7; font-weight: bold;">defstruct</span> <span style="color: #ce537a; font-weight: bold;">settings</span>
   (srcdir libdir bindir package force optimize debug static static-debug verbose build-deps
    libdir-prefix parallelize)
   <span style="color: #4f97d7;">transparent:</span> <span style="color: #4f97d7;">#t</span> <span style="color: #4f97d7;">constructor:</span> <span style="color: #4f97d7;">:init!</span>)

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">current-make-settings</span> (make-parameter <span style="color: #4f97d7;">#f</span>))
</pre>
</div>

<p>
One of the reasons behind this is to use many cores while compiling.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">gerbil-build-cores</span>)
  (with-catch (<span style="color: #4f97d7; font-weight: bold;">lambda</span> (<span style="color: #4f97d7;">_</span>) (<span style="color: #4f97d7;">##</span>cpu-count)) (<span style="color: #4f97d7; font-weight: bold;">lambda</span> () (string-&gt;number (getenv <span style="color: #2d9574;">"GERBIL_BUILD_CORES"</span>)))))
</pre>
</div>

<p>
In the init things need to change as well.
</p>


<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">defmethod</span> <span style="color: #7590db;">{</span><span style="color: #4f97d7;">:init!</span> settings<span style="color: #7590db;">}</span>
 (<span style="color: #4f97d7; font-weight: bold;">lambda</span> (self
     <span style="color: #4f97d7;">srcdir:</span> (srcdir<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">libdir:</span> (libdir<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">bindir:</span> (bindir<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">package:</span> (package<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">force:</span> (force? <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">optimize:</span> (optimize <span style="color: #4f97d7;">#t</span>) <span style="color: #4f97d7;">debug:</span> (debug <span style="color: #4f97d7; font-weight: bold;">'</span>env)
     <span style="color: #4f97d7;">static:</span> (static <span style="color: #4f97d7;">#t</span>) <span style="color: #4f97d7;">static-debug:</span> (static-debug <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">verbose:</span> (verbose <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">build-deps:</span> (build-deps<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">parallelize:</span> (parallelize<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#t</span>))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">gerbil-path</span> (getenv <span style="color: #2d9574;">"GERBIL_PATH"</span> <span style="color: #2d9574;">"~/.gerbil"</span>))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">srcdir</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> srcdir<span style="color: #4f97d7;">_</span> (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"srcdir must be specified"</span>)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">libdir</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> libdir<span style="color: #4f97d7;">_</span> (path-expand <span style="color: #2d9574;">"lib"</span> gerbil-path)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">bindir</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> bindir<span style="color: #4f97d7;">_</span> (path-expand <span style="color: #2d9574;">"bin"</span> gerbil-path)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">package</span> (<span style="color: #4f97d7; font-weight: bold;">and</span> package<span style="color: #4f97d7;">_</span> (<span style="color: #4f97d7; font-weight: bold;">if</span> (symbol? package<span style="color: #4f97d7;">_</span>) (symbol-&gt;string package<span style="color: #4f97d7;">_</span>) package<span style="color: #4f97d7;">_</span>)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">libdir-prefix</span> (<span style="color: #4f97d7; font-weight: bold;">if</span> package (path-expand package libdir) libdir))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">build-deps</span> (path-expand (<span style="color: #4f97d7; font-weight: bold;">or</span> build-deps<span style="color: #4f97d7;">_</span> <span style="color: #2d9574;">"build-deps"</span>) srcdir))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">parallelize</span> (<span style="color: #4f97d7; font-weight: bold;">if</span> (eq? parallelize<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#t</span>) (gerbil-build-cores) (<span style="color: #4f97d7; font-weight: bold;">or</span> parallelize<span style="color: #4f97d7;">_</span> 0)))
   (struct-instance-init!
     self
     srcdir libdir bindir package force? optimize debug static static-debug verbose build-deps
     libdir-prefix parallelize))
 <span style="color: #4f97d7;">rebind:</span> <span style="color: #4f97d7;">#t</span>)
</pre>
</div>

<p>
Now for the compilations. Rather than have it all chunked together I'll break it
into parts I can grasp a wee bit more.
</p>
</div>
</div>

<div id="outline-container-orgd03bc43" class="outline-4">
<h4 id="gxc_outputs_begin"><code>gxc-outputs</code>: the end of the beginning</h4>
<div class="outline-text-4" id="text-gxc_outputs_begin">
<p>
Strangely enough, it seems that the entire reason I started this was an error
that may get taken care of by redefining <code>gxc-outputs</code>.
</p>

<p>
Essentially, I want to return a list of the files <code>gxc</code> transpiles to, and any
static files that are output.
</p>

<p>
I need to know a few paths
</p>
<ol class="org-ol">
<li>The source code path</li>
<li>The library path</li>
<li>The static path</li>
</ol>
</div>

<ul class="org-ul">
<li><a id="org79247a5"></a>Source path<br />
<div class="outline-text-5" id="text-org79247a5">
<p>
The first is easy.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">source-path</span> mod ext settings)
  (path-expand (path-default-extension mod ext) (settings-srcdir settings)))
</pre>
</div>
</div>
</li>

<li><a id="org54d56b3"></a>Library Path and Packages: The end all be all<br />
<div class="outline-text-5" id="text-org54d56b3">
<p>
The compiler can put the compiled files in different locations that all depend
on the package of that source file.
</p>

<p>
We call a source file a <code>mod</code>. This is a string like "test/hello".
</p>

<p>
Every source file compiled by <code>gxc</code> is also a <a href="https://github.com/vyzo/gerbil/blob/master/src/gerbil/expander/module.ss">module</a>. It may have a different
super-package based on the <code>package:</code> keyword in the file or in a local or
parent <code>gerbil.pkg</code>.
</p>

<p>
The packages postfix to the library path then together they prefix the result
location. It also may not exist.
</p>

<p>
These are how they are discovered, in order.
</p>

<ol class="org-ol">
<li>The <code>module-id</code> of the module, or..</li>
<li>The <code>gerbil.pkg</code> in the directory containing the source file itself OR any
parent directories up to <code>srcdir:</code>. If not&#x2026;</li>
<li>The <code>package:</code> option to the make <code>settings</code>.</li>
</ol>


<p>
Let's add a few test files
</p>

<p>
A toplevel <code>test/gerbil.pkg</code>
</p>
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7;">package:</span> drewc/build-test)
</pre>
</div>

<p>
Another one in <code>test/sub/gerbil.pkg</code>.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7;">package:</span> drewc/take-on-me)
</pre>
</div>

<p>
A source file <code>test/sub/goodbye.ss</code>
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">export</span> gbye)

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">gbye</span>) <span style="color: #2d9574;">"Goodbye World"</span>)
</pre>
</div>
</div>

<ul class="org-ul">
<li><a id="orgd46d6a8"></a><code>mod-module</code>: Every <code>.ss</code> is a module<br />
<div class="outline-text-6" id="text-orgd46d6a8">
<p>
An <code>-id</code> is a symbol, a <code>-package</code> a string.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">mod-modules</span> (make-hash-table)) <span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">cache</span>
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">mod-module</span> mod (settings (current-make-settings)) (reload? <span style="color: #4f97d7;">#f</span>))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> (v (hash-ref mod-modules mod (void)))
    (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">and</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> (void? v)) (<span style="color: #4f97d7; font-weight: bold;">not</span> reload?)) v
        (<span style="color: #4f97d7; font-weight: bold;">let*</span> ((src (source-path mod <span style="color: #2d9574;">".ss"</span> settings))
               (m (<span style="color: #4f97d7; font-weight: bold;">and</span> (file-exists? src) (gx<span style="color: #4f97d7;">#</span>import-module src reload?))))
          (<span style="color: #4f97d7; font-weight: bold;">begin0</span> m (hash-put! mod-modules mod m))))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-id</span> gx<span style="color: #4f97d7;">#</span>expander-context-id)
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-id-set!</span> gx<span style="color: #4f97d7;">#</span>expander-context-id-set!)
</pre>
</div>

<p>
(For our <code>"test/hello"</code> mod, <code>test/sub/gbye</code> and <code>"test/hello-no-package"</code>, it is
correct.
</p>

<dl class="org-dl">
<dt><code>"test/hello"</code></dt><dd>has <code>package: drewc</code> at the top. That defines the
containing package as <code>drewc</code>, and since this file is
called <code>hello</code>, the id is <code>drewc/hello</code>.</dd>
<dt><code>"test/hello-no-package"</code></dt><dd>It is <code>drewc/build-test/hello-no-package</code> with the
prefix coming from the <code>test/gerbil.pkg</code></dd>
<dt><code>"test/sub/goodbyebye:</code> </dt><dd><code>drewc/take-on-me</code> is the container from
<code>test/sub/gerbil.pkg</code></dd>
</dl>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:std/test</span>)
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test-settings</span> (settings <span style="color: #4f97d7;">srcdir:</span> <span style="color: #2d9574;">"~/src/gerbil-build"</span>))

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test/hello-module</span> (mod-module <span style="color: #2d9574;">"test/hello"</span> test-settings))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test/sub/goodbye-module</span> (mod-module <span style="color: #2d9574;">"test/sub/goodbye"</span> test-settings <span style="color: #4f97d7;">#t</span>))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test/hello-no-package-module</span> (mod-module <span style="color: #2d9574;">"test/hello-no-package"</span> test-settings))

(check (module-id test/hello-module) <span style="color: #4f97d7;">=&gt;</span> <span style="color: #4f97d7; font-weight: bold;">'</span>drewc/hello)
(check (module-id test/sub/goodbye-module) <span style="color: #4f97d7;">=&gt;</span> <span style="color: #4f97d7; font-weight: bold;">'</span>drewc/take-on-me/goodbye)
(check (module-id test/hello-no-package-module)
       <span style="color: #4f97d7;">=&gt;</span> <span style="color: #4f97d7; font-weight: bold;">'</span>drewc/build-test/hello-no-package)
</pre>
</div>
</div>
</li>

<li><a id="orgb5a3792"></a><code>mod-core-module</code>: The module has no root<br />
<div class="outline-text-6" id="text-orgb5a3792">
<p>
Finding the actual package can be a problem if we have it laid out on the
filesystem where any of the parents have a <code>gerbil.pkg</code>.
</p>

<p>
For example, a git subtree that you want to build should not change based on
the fact that you store it in another directory.
</p>

<p>
We'll lay out a new project and a file like this:
</p>

<p>
<b>./test/new-project/hello-no-package.ss</b>
</p>

<p>
Now, without any package and without a <code>gerbil.pkg</code>, when we try to make that
project, what comes up?
</p>


<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">export</span> hello)
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">hello</span>) <span style="color: #2d9574;">"Hello World... New Project!"</span>)
</pre>
</div>


<div class="org-src-container">
<pre class="src src-scheme"> (<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:std/test</span>)
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test-new-project-settings</span> (settings <span style="color: #4f97d7;">srcdir:</span> <span style="color: #2d9574;">"~/src/gerbil-build/test/new-project"</span>)) 

 (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test/new-project-hello-no-package-module</span>
   (mod-module <span style="color: #2d9574;">"new-hello-no-package"</span> test-new-project-settings))

 <span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">This passes the test, but fails at what we want</span>
 (check (module-id test/new-project-hello-no-package-module)
        <span style="color: #4f97d7;">=&gt;</span> <span style="color: #4f97d7; font-weight: bold;">'</span>drewc/build-test/new-project/new-hello-no-package)
</pre>
</div>

<p>
The importer always looks towards parent directories for a package. That makes
sense as it cannot know where to stop and always tried to succeed. That is a
wonderful thing that makes life so much easier, but does result in some antics.
</p>

<p>
As luck would have it, <b>vyzo</b> has taken care of the details in
<code>gx#core-read-module</code>.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">mod-core-modules</span> (make-hash-table))
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">mod-core-module</span> mod (settings (current-make-settings)) (reload? <span style="color: #4f97d7;">#f</span>))
  <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt; (values prelude module-id module-ns body)</span>
  (<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">mrm</span>)
    (<span style="color: #4f97d7; font-weight: bold;">let</span> (v (<span style="color: #4f97d7; font-weight: bold;">if</span> reload? (void) (hash-ref mod-core-modules mod (void))))
      (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> (void? v)) v
          (<span style="color: #4f97d7; font-weight: bold;">let*</span> ((src (path-force-extension mod <span style="color: #2d9574;">".ss"</span>))
                 (rm (<span style="color: #4f97d7; font-weight: bold;">and</span> (file-exists? src) (gx<span style="color: #4f97d7;">#</span>core-read-module src))))
            (<span style="color: #4f97d7; font-weight: bold;">begin0</span> rm (hash-put! mod-core-modules mod rm))))))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> ((srcdir (path-normalize (settings-srcdir settings)))
        (cd (path-normalize (current-directory))))
    (<span style="color: #4f97d7; font-weight: bold;">if</span> (equal? srcdir cd) (mrm)
        (<span style="color: #4f97d7; font-weight: bold;">parameterize</span> ((current-directory srcdir))
          (mrm)))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">core-module-prelude</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> values-ref <span style="color: #4f97d7;">&lt;&gt;</span> 0))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">core-module-id</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> values-ref <span style="color: #4f97d7;">&lt;&gt;</span> 1))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">core-module-ns</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> values-ref <span style="color: #4f97d7;">&lt;&gt;</span> 2))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">core-module-code</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> values-ref <span style="color: #4f97d7;">&lt;&gt;</span> 3))
</pre>
</div>

<p>
With that we can now see that this has no package.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:std/test</span>)

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test/new-project-hello-no-package-core-module</span>
  (mod-core-module <span style="color: #2d9574;">"new-hello-no-package"</span> test-new-project-settings))

(check (core-module-id test/new-project-hello-no-package-core-module)
       <span style="color: #4f97d7;">=&gt;</span> <span style="color: #4f97d7; font-weight: bold;">'</span>new-hello-no-package)
</pre>
</div>
</div>
</li>

<li><a id="org143e833"></a>Some testing and asking the compiler where it places things<br />
<div class="outline-text-6" id="text-org143e833">
<p>
What happens when we compile that module as is?
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test-new-project-settings</span> (settings <span style="color: #4f97d7;">srcdir:</span> <span style="color: #2d9574;">"~/src/gerbil-build/test/new-project"</span>))

 (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test/new-project-hello-no-package-module</span>
   (mod-module <span style="color: #2d9574;">"new-hello-no-package"</span> test-new-project-settings))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">rm ~/.gerbil/lib/drewc/build-test/new-project/new-hello-no-package*
gxi -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/make1.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/test-make-gxc.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/test-compile-as-is.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(make-ss "~/src/gerbil-build/test/new-project/new-hello-no-package.ss")'</span>
</pre>
</div>


<p>
It ends up in <b>~/.gerbil/lib/drewc/build-test/new-project/</b>. We knew that.
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt; [...]</span>
compile drewc/build-test/new-project/new-hello-no-package
</pre>
</div>


<p>
If we set the id to <code>new-hello-no-package</code>, say from the <code>core-module-id</code>?
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test/new-project-hello-no-package-core-module</span>
    (mod-core-module <span style="color: #2d9574;">"new-hello-no-package"</span> test-new-project-settings))

(<span style="color: #4f97d7; font-weight: bold;">set!</span> (module-id test/new-project-hello-no-package-module)
      (core-module-id test/new-project-hello-no-package-core-module))
</pre>
</div>



<p>
Awesome! That should now means that it tests out.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:std/test</span> <span style="color: #4f97d7;">:new-hello-no-package</span>)
(check (hello) <span style="color: #4f97d7;">=&gt;</span> <span style="color: #2d9574;">"Hello World... New Project!"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">rm ~/.gerbil/lib/drewc/new-hello-no-package*
gxi -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/make1.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/test-make-gxc.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/test-compile-as-is.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/test-compile-set-id.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(make-ss "~/src/gerbil-build/test/new-project/new-hello-no-package.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/test-new-hello-no-package.ss")'</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt;</span>
... check <span style="color: #4f97d7;">(</span>hello<span style="color: #4f97d7;">)</span> is equal? to <span style="color: #2d9574;">"Hello World... New Project!"</span>
</pre>
</div>
</div>
</li>


<li><a id="org7241b95"></a><code>mod-module-id</code>: Finally, we know where it is and how to set it<br />
<div class="outline-text-6" id="text-org7241b95">
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">mod-module-id</span> mod (settings (current-make-settings)))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> ((mcm (mod-core-module mod settings))
        (sp (settings-package settings)))
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If the core module package is the same as the mod that means we could not</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">find a package.</span>
    (<span style="color: #4f97d7; font-weight: bold;">if</span> (equal? mod (symbol-&gt;string (core-module-id mcm)))
      <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If we do not have a toplevel package we are the package.</span>
      (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> sp) (string-&gt;symbol mod)
          <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">otherwise add it as a super and return</span>
          (string-&gt;symbol (path-expand mod sp)))
      <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">Otherwise the mrm has the right id</span>
      (core-module-id mcm))))
</pre>
</div>

<p>
Yes! Now we can specify where things go based on where they are.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:std/test</span>)
(<span style="color: #4f97d7; font-weight: bold;">let*</span> ((mod <span style="color: #2d9574;">"new-hello-no-package"</span>)
       (modn (path-expand mod <span style="color: #2d9574;">"new-project"</span>))
       (modtn (path-expand modn <span style="color: #2d9574;">"test"</span>))
       (newsetdir <span style="color: #2d9574;">"~/src/gerbil-build/test/new-project"</span>)
       (testsetdir
        (path-directory (path-strip-trailing-directory-separator newsetdir)))
       (srcsetdir
        (path-directory (path-strip-trailing-directory-separator testsetdir))))

  <span style="color: #2aa1ae; background-color: #292e34;">;;  </span><span style="color: #2aa1ae; background-color: #292e34;">make'ing it from that directory should have no container</span>

  (check (mod-module-id mod (settings <span style="color: #4f97d7;">srcdir:</span> newsetdir)) <span style="color: #4f97d7;">=&gt;</span> <span style="color: #4f97d7; font-weight: bold;">'</span>new-hello-no-package)

  <span style="color: #2aa1ae; background-color: #292e34;">;;  </span><span style="color: #2aa1ae; background-color: #292e34;">make'ing it from the parent picks up the parents gerbil.pkg</span>

  (check (mod-module-id modn (settings <span style="color: #4f97d7;">srcdir:</span> srcsetdir))
         <span style="color: #4f97d7;">=&gt;</span> <span style="color: #4f97d7; font-weight: bold;">'</span>drewc/build-test/new-project/new-hello-no-package)

  <span style="color: #2aa1ae; background-color: #292e34;">;;  </span><span style="color: #2aa1ae; background-color: #292e34;">make'ing it from the parent parent's parent should also picks up the</span>
  <span style="color: #2aa1ae; background-color: #292e34;">;;  </span><span style="color: #2aa1ae; background-color: #292e34;">parents gerbil.pkg</span>

  (check (mod-module-id modtn (settings <span style="color: #4f97d7;">srcdir:</span> testsetdir))
         <span style="color: #4f97d7;">=&gt;</span> <span style="color: #4f97d7; font-weight: bold;">'</span>drewc/build-test/new-project/new-hello-no-package))
</pre>
</div>
</div>
</li>
</ul>
</li>

<li><a id="org0e4ac8a"></a><code>namespace:</code> and <code>prelude</code>: Two other things that are set for modules<br />
<div class="outline-text-5" id="text-org0e4ac8a">
<p>
The compiler also picks up those keywords from a parent so that even
setting the <code>module-id</code> can leave us with some surprises.
</p>

<p>
When we name a hello something else, we can import it as such.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test/new-project-hello-no-package-core-module</span>
    (mod-core-module <span style="color: #2d9574;">"new-hello-no-package"</span> test-new-project-settings))

(<span style="color: #4f97d7; font-weight: bold;">set!</span> (module-id test/new-project-hello-no-package-module) <span style="color: #4f97d7; font-weight: bold;">'</span>foobarbaz)
</pre>
</div>


<p>
The issue is that the namespace is not set correctly. For example, the <code>test/hello.ss</code> file.
</p>


<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:std/test</span> <span style="color: #4f97d7;">:drewc/hello</span>)
(check (drewc/hello<span style="color: #4f97d7;">#</span>hello) <span style="color: #4f97d7;">=&gt;</span> <span style="color: #2d9574;">"Hello World"</span>)
</pre>
</div>

<p>
But, for that <code>:foobarbaz</code> it's quite different.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:std/sugar</span> <span style="color: #4f97d7;">:std/test</span> <span style="color: #4f97d7;">:foobarbaz</span>)
(check (hello) <span style="color: #4f97d7;">=&gt;</span> <span style="color: #2d9574;">"Hello World... New Project!"</span>)

<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">This test passes but it shoudn't</span>
(check (<span style="color: #4f97d7; font-weight: bold;">try</span> (foobarbaz<span style="color: #4f97d7;">#</span>hello) (<span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>)) <span style="color: #4f97d7;">=&gt;</span> <span style="color: #4f97d7;">#f</span>)

<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">because it's in another namespace</span>
(check (drewc/build-test/new-project/new-hello-no-package<span style="color: #4f97d7;">#</span>hello)
       <span style="color: #4f97d7;">=&gt;</span> <span style="color: #2d9574;">"Hello World... New Project!"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">rm ~/.gerbil/foobarbaz*
gxi -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/make1.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/test-make-gxc.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/test-compile-as-is.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/test-compile-set-id-to-foobarbaz.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(make-ss "~/src/gerbil-build/test/new-project/new-hello-no-package.ss")'</span><span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/test-improper-namespace.ss")'</span> <span style="color: #2d9574;">\</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt;</span>
... check <span style="color: #4f97d7;">(</span>hello<span style="color: #4f97d7;">)</span> is equal? to <span style="color: #2d9574;">"Hello World... New Project!"</span>
... check <span style="color: #4f97d7;">(</span>try <span style="color: #bc6ec5;">(</span>foobarbaz#hello<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">(</span>catch _ <span style="color: #2aa1ae; background-color: #292e34;">#</span><span style="color: #2aa1ae; background-color: #292e34;">f)) is equal? to #f</span>
... check <span style="color: #2d9574;">(</span>drewc/build-test/new-project/new-hello-no-package#hello<span style="color: #2d9574;">)</span> is equal? to <span style="color: #2d9574;">"Hello World... New Project!"</span>
</pre>
</div>

<p>
That's because of the <code>module-namespace</code>.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-ns</span> gx<span style="color: #4f97d7;">#</span>module-context-ns)
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-ns-set!</span> gx<span style="color: #4f97d7;">#</span>module-context-ns-set!)
</pre>
</div>

<p>
If we set it, we should get it?
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test/new-project-hello-no-package-core-module</span>
    (mod-core-module <span style="color: #2d9574;">"new-hello-no-package"</span> test-new-project-settings))

(<span style="color: #4f97d7; font-weight: bold;">set!</span> (module-id test/new-project-hello-no-package-module) <span style="color: #4f97d7; font-weight: bold;">'</span>foobarbaz)
(<span style="color: #4f97d7; font-weight: bold;">set!</span> (module-ns test/new-project-hello-no-package-module) <span style="color: #2d9574;">"foobarbaz"</span>)
</pre>
</div>

<p>
Here's the test &#x2026;
</p>


<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:std/sugar</span> <span style="color: #4f97d7;">:std/test</span> <span style="color: #4f97d7;">:foobarbaz</span>)
(check (hello) <span style="color: #4f97d7;">=&gt;</span> <span style="color: #2d9574;">"Hello World... New Project!"</span>)

<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">This test passes!</span>

(check (foobarbaz<span style="color: #4f97d7;">#</span>hello) <span style="color: #4f97d7;">=&gt;</span> <span style="color: #2d9574;">"Hello World... New Project!"</span>)

<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">because it's not in another namespace</span>
(check (<span style="color: #4f97d7; font-weight: bold;">try</span> (drewc/build-test/new-project/new-hello-no-package<span style="color: #4f97d7;">#</span>hello)
         (<span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>)) <span style="color: #4f97d7;">=&gt;</span> <span style="color: #4f97d7;">#f</span>)
</pre>
</div>

<p>
&#x2026; but our test seems to fail. I think that's because the body is <a href="https://github.com/vyzo/gerbil/blob/master/src/gerbil/expander/module.ss#L173">set before</a> we
set the namespace.
</p>

<p>
We'll nick that.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">prep-module-code</span> module code)
  (gx<span style="color: #4f97d7;">#</span>core-quote-syntax (gx<span style="color: #4f97d7;">#</span>core-cons <span style="color: #4f97d7; font-weight: bold;">'</span><span style="color: #4f97d7;">%#begin</span> code)
 (gx<span style="color: #4f97d7;">#</span>module-context-path module) module <span style="color: #7590db;">[]</span>))
</pre>
</div>

<p>
And?
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test/new-project-hello-no-package-core-module</span>
    (mod-core-module <span style="color: #2d9574;">"new-hello-no-package"</span> test-new-project-settings))

(<span style="color: #4f97d7; font-weight: bold;">set!</span> (module-id test/new-project-hello-no-package-module) <span style="color: #4f97d7; font-weight: bold;">'</span>foobarbaz)
(<span style="color: #4f97d7; font-weight: bold;">set!</span> (module-ns test/new-project-hello-no-package-module) <span style="color: #2d9574;">"foobarbaz"</span>)

(<span style="color: #4f97d7; font-weight: bold;">set!</span> (gx<span style="color: #4f97d7;">#</span>&amp;module-context-code test/new-project-hello-no-package-module)
  (prep-module-code test/new-project-hello-no-package-module (core-module-code test/new-project-hello-no-package-core-module)))

</pre>
</div>


<p>
Nope, still doesn't work. That's ok, the code knows.
</p>
</div>

<ul class="org-ul">
<li><a id="orgce78632"></a><code>(def module-id [...]</code><br />
<div class="outline-text-6" id="text-orgce78632">
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-name</span> (path-strip-directory (path-strip-extension path)))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-id</span>
  <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If we provide _id, use it(d)!</span>
  (<span style="color: #4f97d7; font-weight: bold;">or</span> <span style="color: #4f97d7;">_</span>id
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If the core module package is the same as the mod that means we could not</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">find a package.</span>
    (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> (equal? module-name (symbol-&gt;string id))) id
      <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If we do not have a toplevel package we are the id.</span>
      (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> <span style="color: #4f97d7;">_</span>package) id
          <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">otherwise add it as the package as a supercontainer and return</span>
          (string-&gt;symbol (path-expand module-name (symbol-&gt;string <span style="color: #4f97d7;">_</span>package)))))))
</pre>
</div>
</div>
</li>

<li><a id="org43823d7"></a><code>(def module-ns [...]</code><br />
<div class="outline-text-6" id="text-org43823d7">
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-ns</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> <span style="color: #4f97d7;">_</span>ns (<span style="color: #4f97d7; font-weight: bold;">if</span> (equal? module-name ns) (symbol-&gt;string module-id) ns)))
</pre>
</div>
</div>
</li>

<li><a id="org8cccadb"></a><code>prep-import-module</code><br />
<div class="outline-text-6" id="text-org8cccadb">
<p>
This <a href="https://github.com/vyzo/gerbil/blob/master/src/gerbil/expander/module.ss#L257">is cribbed as well</a>. Because the compiler does not re-import it, we set it
here and that's that. It also means we get rid of almost all the <code>mod-*</code> and
<code>mod-core</code> code.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">-*- Gerbil -*-</span>
<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">(C) vyzo at hackzen.org, me at drewc.ca</span>
(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:gerbil/expander/module</span> <span style="color: #4f97d7;">:std/lazy</span>)
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">prep-import-module</span>
      rpath
      <span style="color: #4f97d7;">srcdir:</span> (srcdir <span style="color: #2d9574;">"/"</span>)
      <span style="color: #4f97d7;">package:</span> (<span style="color: #4f97d7;">_</span>package <span style="color: #4f97d7;">#f</span>)
      <span style="color: #4f97d7;">id:</span> (<span style="color: #4f97d7;">_</span>id <span style="color: #4f97d7;">#f</span>)
      <span style="color: #4f97d7;">namespace:</span> (<span style="color: #4f97d7;">_</span>ns <span style="color: #4f97d7;">#f</span>)
      <span style="color: #4f97d7;">pre:</span> (<span style="color: #4f97d7;">_</span>pre <span style="color: #4f97d7;">#f</span>)
      (reload? <span style="color: #4f97d7;">#f</span>))

  (<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">import-source</span> path)
    (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">mod-path</span> (path-normalize path (<span style="color: #4f97d7; font-weight: bold;">or</span> srcdir <span style="color: #4f97d7;">#f</span>) (<span style="color: #4f97d7; font-weight: bold;">or</span> srcdir <span style="color: #2d9574;">""</span>)))

    (<span style="color: #4f97d7; font-weight: bold;">when</span> (member path (gx<span style="color: #4f97d7;">#</span>current-expander-path))
      (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"Cyclic expansion"</span> path))
    (<span style="color: #4f97d7; font-weight: bold;">parameterize</span> ((gx<span style="color: #4f97d7;">#</span>current-expander-context (gx<span style="color: #4f97d7;">#</span>core-context-root))
                   (gx<span style="color: #4f97d7;">#</span>current-expander-marks <span style="color: #7590db;">[]</span>)
                   (gx<span style="color: #4f97d7;">#</span>current-expander-phi 0)
                   (gx<span style="color: #4f97d7;">#</span>current-expander-path
                    (cons path (gx<span style="color: #4f97d7;">#</span>current-expander-path)))
                   (gx<span style="color: #4f97d7;">#</span>current-import-expander-phi <span style="color: #4f97d7;">#f</span>)
                   (gx<span style="color: #4f97d7;">#</span>current-export-expander-phi <span style="color: #4f97d7;">#f</span>))
      (<span style="color: #4f97d7; font-weight: bold;">let-values</span> (((pre id ns body)
                    (gx<span style="color: #4f97d7;">#</span>core-read-module mod-path)))
        (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-name</span> (path-strip-directory (path-strip-extension path)))
        (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-id</span>
          <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If we provide _id, use it(d)!</span>
          (<span style="color: #4f97d7; font-weight: bold;">or</span> <span style="color: #4f97d7;">_</span>id
            <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If the core module package is the same as the mod that means we could not</span>
            <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">find a package.</span>
            (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> (equal? module-name (symbol-&gt;string id))) id
              <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If we do not have a toplevel package we are the id.</span>
              (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> <span style="color: #4f97d7;">_</span>package) id
                  <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">otherwise add it as the package as a supercontainer and return</span>
                  (string-&gt;symbol (path-expand module-name (symbol-&gt;string <span style="color: #4f97d7;">_</span>package)))))))
        (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-ns</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> <span style="color: #4f97d7;">_</span>ns (<span style="color: #4f97d7; font-weight: bold;">if</span> (equal? module-name ns) (symbol-&gt;string module-id) ns)))
        (<span style="color: #4f97d7; font-weight: bold;">let*</span> ((prelude
                (<span style="color: #4f97d7; font-weight: bold;">cond</span>
                 ((gx<span style="color: #4f97d7;">#</span>prelude-context? pre) pre)
                 ((gx<span style="color: #4f97d7;">#</span>module-context? pre)
                  (gx<span style="color: #4f97d7;">#</span>core-module-&gt;prelude-context pre))
                 ((string? pre)
                  (gx<span style="color: #4f97d7;">#</span>core-module-&gt;prelude-context
                   (core-import-module pre)))
                 ((<span style="color: #4f97d7; font-weight: bold;">not</span> pre)
                  (<span style="color: #4f97d7; font-weight: bold;">or</span> (gx<span style="color: #4f97d7;">#</span>current-expander-module-prelude)
                      (gx<span style="color: #4f97d7;">#</span>make-prelude-context <span style="color: #4f97d7;">#f</span>)))
                 (<span style="color: #4f97d7; font-weight: bold;">else</span>
                  (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"Cannot import module; unknown prelude"</span> rpath pre))))
               (ctx
                (gx<span style="color: #4f97d7;">#</span>make-module-context module-id prelude module-ns path))
               (body
               (gx<span style="color: #4f97d7;">#</span>core-expand-module-begin body ctx))
               (body
                (gx<span style="color: #4f97d7;">#</span>core-quote-syntax
                 (gx<span style="color: #4f97d7;">#</span>core-cons <span style="color: #4f97d7; font-weight: bold;">'</span><span style="color: #4f97d7;">%#begin</span> body)
                 path ctx <span style="color: #7590db;">[]</span>)))
           (<span style="color: #4f97d7; font-weight: bold;">set!</span> (gx<span style="color: #4f97d7;">#</span>&amp;module-context-e ctx)
             (<span style="color: #4f97d7; font-weight: bold;">delay</span> (gx<span style="color: #4f97d7;">#</span>eval-syntax* body)))
          (<span style="color: #4f97d7; font-weight: bold;">set!</span> (gx<span style="color: #4f97d7;">#</span>&amp;module-context-code ctx)
            body)
          (hash-put! (gx<span style="color: #4f97d7;">#</span>current-expander-module-registry) path ctx)
          (hash-put! (gx<span style="color: #4f97d7;">#</span>current-expander-module-registry) id ctx)
          ctx))))

  (<span style="color: #4f97d7; font-weight: bold;">let</span> (npath (path-normalize rpath <span style="color: #4f97d7;">#f</span>))
    (<span style="color: #4f97d7; font-weight: bold;">cond</span>
     ((<span style="color: #4f97d7; font-weight: bold;">and</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> reload?)
           (hash-get (gx<span style="color: #4f97d7;">#</span>current-expander-module-registry) npath))
      <span style="color: #4f97d7;">=&gt;</span> <span style="color: #4f97d7; font-weight: bold;">values</span>)
     (<span style="color: #4f97d7; font-weight: bold;">else</span> (<span style="color: #4f97d7; font-weight: bold;">parameterize</span> ((current-directory (<span style="color: #4f97d7; font-weight: bold;">or</span> srcdir (current-directory))))
             (import-source (path-normalize rpath <span style="color: #4f97d7;">#f</span>)))))))

</pre>
</div>
</div>
</li>



<li><a id="orgea4bf5c"></a>Time to test!<br />
<div class="outline-text-6" id="text-orgea4bf5c">
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:std/test</span>)
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test/foobarbaz-module</span>
  (prep-import-module
   (source-path <span style="color: #2d9574;">"new-hello-no-package"</span> <span style="color: #2d9574;">".ss"</span> test-new-project-settings)
   <span style="color: #4f97d7;">srcdir:</span> (settings-srcdir test-new-project-settings)
   <span style="color: #4f97d7;">id:</span> <span style="color: #4f97d7; font-weight: bold;">'</span>foobarbaz <span style="color: #4f97d7;">#t</span>))

(check (module-id test/foobarbaz-module) <span style="color: #4f97d7;">=&gt;</span> <span style="color: #4f97d7; font-weight: bold;">'</span>foobarbaz)


</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">rm ~/.gerbil/lib/foobarbaz*
gxi -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/make1.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/test-make-gxc.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/import.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/test-compile-as-is.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/test-compile-prep-foobarbaz.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(make-ss "~/src/gerbil-build/test/new-project/new-hello-no-package.ss")'</span><span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/test-proper-namespace.ss")'</span> <span style="color: #2d9574;">\</span>
</pre>
</div>


<p>
Yes! It worked.
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt;</span>
... check <span style="color: #4f97d7;">(</span>hello<span style="color: #4f97d7;">)</span> is equal? to <span style="color: #2d9574;">"Hello World... New Project!"</span>
... check <span style="color: #4f97d7;">(</span>foobarbaz#hello<span style="color: #4f97d7;">)</span> is equal? to <span style="color: #2d9574;">"Hello World... New Project!"</span>
... check <span style="color: #4f97d7;">(</span>try <span style="color: #bc6ec5;">(</span>drewc/build-test/new-project/new-hello-no-package#hello<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">(</span>catch _ <span style="color: #2aa1ae; background-color: #292e34;">#</span><span style="color: #2aa1ae; background-color: #292e34;">f)) is equal? to #f</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">export</span> hello)
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">hello</span>) <span style="color: #2d9574;">"Hello World... New Project!"</span>)
</pre>
</div>
</div>
</li>


<li><a id="orge80a98b"></a>Prelude and Postlude: Putting it all together<br />
<div class="outline-text-6" id="text-orge80a98b">
<p>
The only thing we're missing is a way to set a prelude in the make
settings. In fact, we don't set the namespace there either.
</p>

<p>
Let's unite things. We'll create a <code>settings-gerbil.pkg</code> accessor.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">Settings: see details in doc/reference/make.md</span>
(<span style="color: #4f97d7; font-weight: bold;">defstruct</span> <span style="color: #ce537a; font-weight: bold;">settings</span>
  (srcdir libdir bindir force optimize debug static
          static-debug verbose build-deps parallelize gerbil.pkg)
  <span style="color: #4f97d7;">transparent:</span> <span style="color: #4f97d7;">#t</span> <span style="color: #4f97d7;">constructor:</span> <span style="color: #4f97d7;">:init!</span>)

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">current-make-settings</span> (make-parameter <span style="color: #4f97d7;">#f</span>))
</pre>
</div>


<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">read-gerbil.pkg-plist</span> srcdir)
  (with-catch
   false (<span style="color: #4f97d7; font-weight: bold;">lambda</span> () (<span style="color: #4f97d7; font-weight: bold;">call-with-input-file</span> (path-expand <span style="color: #2d9574;">"gerbil.pkg"</span> srcdir) read))))

(<span style="color: #4f97d7; font-weight: bold;">defmethod</span> <span style="color: #7590db;">{</span><span style="color: #4f97d7;">:init!</span> settings<span style="color: #7590db;">}</span>
 (<span style="color: #4f97d7; font-weight: bold;">lambda</span> (self
     <span style="color: #4f97d7;">srcdir:</span> (srcdir<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">libdir:</span> (libdir<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">bindir:</span> (bindir<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">gerbil.pkg:</span> (gxpkg<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">force:</span> (force? <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">optimize:</span> (optimize <span style="color: #4f97d7;">#t</span>) <span style="color: #4f97d7;">debug:</span> (debug <span style="color: #4f97d7; font-weight: bold;">'</span>env)
     <span style="color: #4f97d7;">static:</span> (static <span style="color: #4f97d7;">#t</span>) <span style="color: #4f97d7;">static-debug:</span> (static-debug <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">verbose:</span> (verbose <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">build-deps:</span> (build-deps<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">parallelize:</span> (parallelize<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#t</span>))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">gerbil-path</span> (getenv <span style="color: #2d9574;">"GERBIL_PATH"</span> <span style="color: #2d9574;">"~/.gerbil"</span>))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">srcdir</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> srcdir<span style="color: #4f97d7;">_</span> (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"srcdir must be specified"</span>)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">gerbil.pkg</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> gxpkg<span style="color: #4f97d7;">_</span> (read-gerbil.pkg-plist srcdir<span style="color: #4f97d7;">_</span> )))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">libdir</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> libdir<span style="color: #4f97d7;">_</span> (path-expand <span style="color: #2d9574;">"lib"</span> gerbil-path)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">bindir</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> bindir<span style="color: #4f97d7;">_</span> (path-expand <span style="color: #2d9574;">"bin"</span> gerbil-path)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">build-deps</span> (path-expand (<span style="color: #4f97d7; font-weight: bold;">or</span> build-deps<span style="color: #4f97d7;">_</span> <span style="color: #2d9574;">"build-deps"</span>) srcdir))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">parallelize</span> (<span style="color: #4f97d7; font-weight: bold;">if</span> (eq? parallelize<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#t</span>) (gerbil-build-cores) (<span style="color: #4f97d7; font-weight: bold;">or</span> parallelize<span style="color: #4f97d7;">_</span> 0)))
   (struct-instance-init!
     self
     srcdir libdir bindir force? optimize debug static static-debug verbose build-deps
     parallelize gerbil.pkg))
   <span style="color: #4f97d7;">rebind:</span> <span style="color: #4f97d7;">#t</span>)

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">settings-gerbil.pkg-pgetq</span> s k (nope <span style="color: #4f97d7;">#f</span>))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> (plist (settings-gerbil.pkg s))
    (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> plist) nope (pgetq plist k nope))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">settings-package</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> settings-gerbil.pkg-pgetq <span style="color: #4f97d7;">&lt;&gt;</span> <span style="color: #4f97d7;">package:</span>))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">settings-namespace</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> settings-gerbil.pkg-pgetq <span style="color: #4f97d7;">&lt;&gt;</span> <span style="color: #4f97d7;">namespace:</span>))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">settings-prelude</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> settings-gerbil.pkg-pgetq <span style="color: #4f97d7;">&lt;&gt;</span> <span style="color: #4f97d7;">prelude:</span>))
</pre>
</div>


<p>
Now that we've got that taken care of, let's do preludes.
</p>

<p>
"As of Gerbil <code>v0.16-DEV-259-g13646d64</code> gerbil comes with a custom language
prelude, <code>:gerbil/polydactyl</code>, that treats square brackets as plain parentheses
instead of the reader expanding them to @list forms. The language is otherwise
the same as <code>:gerbil/core</code>."
--<a href="https://cons.io/guide/intro.html#core-gerbil-variants">https://cons.io/guide/intro.html#core-gerbil-variants</a>
</p>


<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">export</span> hello)

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">hello</span>) <span style="color: #7590db;">[</span>list . <span style="color: #4f97d7; font-weight: bold;">'</span>(<span style="color: #2d9574;">"Hello World"</span> 2 3)<span style="color: #7590db;">]</span>)
</pre>
</div>

<p>
Without any prelude, that should return a list with a procedure as its member.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test-no-prelude-settings</span> (settings <span style="color: #4f97d7;">srcdir:</span> <span style="color: #2d9574;">"~/src/gerbil-build/test/prelude"</span>))

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test/hello-no-prelude-module</span>
  (prep-import-module
   (source-path <span style="color: #2d9574;">"hello"</span> <span style="color: #2d9574;">".ss"</span> test-no-prelude-settings)
   <span style="color: #4f97d7;">srcdir:</span> (settings-srcdir test-no-prelude-settings)
   <span style="color: #4f97d7;">package:</span> <span style="color: #4f97d7; font-weight: bold;">'</span>no-prelude
   <span style="color: #4f97d7;">namespace:</span> <span style="color: #4f97d7; font-weight: bold;">'</span>np))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:no-prelude/hello</span> <span style="color: #4f97d7;">:std/test</span>)
(check ((car (hello)) (cadr (hello))) <span style="color: #4f97d7;">=&gt;</span> <span style="color: #4f97d7; font-weight: bold;">'</span>(<span style="color: #2d9574;">"Hello World"</span>))
</pre>
</div>

<p>
It works, of course, because this is nothing new.
</p>

<div class="org-src-container">
<pre class="src src-shell">... check <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>car <span style="color: #2d9574;">(</span>np#hello<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span> is equal? to <span style="color: #2d9574;">"Hello World"</span>
</pre>
</div>

<p>
Let's set a prelude.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #4f97d7;">#</span>lang <span style="color: #4f97d7;">:gerbil/polydactyl</span>
<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">does not work? prelude: :gerbil/polydactyl</span>
(<span style="color: #4f97d7; font-weight: bold;">export</span> hello)

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">hello</span>) <span style="color: #7590db;">[</span>list . (<span style="color: #2d9574;">"Hello World"</span> 2 3)<span style="color: #7590db;">]</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">test/hello-no-prelude-prelude-module</span>
  (prep-import-module
   (source-path <span style="color: #2d9574;">"prehello"</span> <span style="color: #2d9574;">".ss"</span> test-no-prelude-settings)
   <span style="color: #4f97d7;">srcdir:</span> (settings-srcdir test-no-prelude-settings)
   <span style="color: #4f97d7;">package:</span> <span style="color: #4f97d7; font-weight: bold;">'</span>no-prelude
   <span style="color: #4f97d7;">namespace:</span> <span style="color: #4f97d7; font-weight: bold;">'</span>np))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:no-prelude/prehello</span> <span style="color: #4f97d7;">:std/test</span>)
(check (car (hello)) <span style="color: #4f97d7;">=&gt;</span><span style="color: #2d9574;">"Hello World"</span>)
</pre>
</div>


<div class="org-src-container">
<pre class="src src-shell">rm -rf ~/.gerbil/lib/no-prelude ~/.gerbil/lib/drewc/build-test/prelude/
gxi -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/make1.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/test-make-gxc.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/import.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/prelude-no-prelude.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/no-prelude-prelude.ss")'</span> <span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(make-ss "~/src/gerbil-build/test/prelude/prehello.ss")'</span><span style="color: #2d9574;">\</span>
    -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/test-no-prelude-prehello.ss")'</span>
</pre>
</div>

<p>
While it works, it turns out the <code>#lang</code> and <code>prelude:</code> are totally different
things. While that is a good thing to learn, it also means the build script need
not worry for now.
</p>

<div class="org-src-container">
<pre class="src src-shell">... check <span style="color: #4f97d7;">(</span>car <span style="color: #bc6ec5;">(</span>hello<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span> is equal? to <span style="color: #2d9574;">"Hello World"</span>
</pre>
</div>
</div>
</li>
</ul>
</li>
</ul>
</div>


<div id="outline-container-org703bf43" class="outline-4">
<h4 id="org703bf43">Break into modules</h4>
<div class="outline-text-4" id="text-org703bf43">
<p>
Before starting on the major reason behind the last 800 or so LiterateLoC's
let's start to break things up into parts. This helps to separate the code
and concerns as well as test itself on itself.
</p>

<p>
First, a <code>base</code> where all things spring from. Well, that is to say, after
pulling the bootstraps.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">force-outputs</span>) (force-output (current-error-port)) (force-output)) <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">move to std/misc/ports ?</span>
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">message</span> . lst) (<span style="color: #4f97d7; font-weight: bold;">apply</span> displayln lst) (force-outputs)) <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">move to std/misc/ports ?</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #4f97d7;">package:</span> std/make
(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:std/misc/list</span> <span style="color: #4f97d7;">:gerbil/gambit/ports</span>)
(<span style="color: #4f97d7; font-weight: bold;">export</span> <span style="color: #4f97d7;">#t</span>)

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">default-gambit-gsc</span> <span style="color: #2d9574;">"gsc"</span>)
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">default-gerbil-gxc</span> <span style="color: #2d9574;">"gxc"</span>)

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">gerbil-gsc</span>)
  (getenv <span style="color: #2d9574;">"GERBIL_GSC"</span> default-gambit-gsc))
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">gerbil-gxc</span>)
  (getenv <span style="color: #2d9574;">"GERBIL_GXC"</span> default-gerbil-gxc))

<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">Functions that should be better moved some library...</span>
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">force-outputs</span>) (force-output (current-error-port)) (force-output)) <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">move to std/misc/ports ?</span>
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">message</span> . lst) (<span style="color: #4f97d7; font-weight: bold;">apply</span> displayln lst) (force-outputs)) <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">move to std/misc/ports ?</span>
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">writeln</span> x) (write x) (newline) (force-outputs)) <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">move to std/misc/ports ?</span>
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">prefix/</span> prefix path) (<span style="color: #4f97d7; font-weight: bold;">if</span> prefix (string-append prefix <span style="color: #2d9574;">"/"</span> path) path)) <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">move to std/misc/path ?</span>

<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">Functions partially reimplemented from std/srfi/43. See bug #465</span>
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">vector-for-each</span> f v)
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">l</span> (vector-length v))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #bc6ec5; font-weight: bold;">loop</span> ((i 0)) (<span style="color: #4f97d7; font-weight: bold;">when</span> (&lt; i l) (<span style="color: #4f97d7; font-weight: bold;">begin</span> (f i (vector-ref v i)) (loop (+ 1 i))))))
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">vector-ensure-ref</span> v i f)
  (<span style="color: #4f97d7; font-weight: bold;">or</span> (vector-ref v i) (<span style="color: #4f97d7; font-weight: bold;">let</span> ((x (f))) (vector-set! v i x) x)))
</pre>
</div>

<p>
Then the settings.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">settings-verbose&gt;=?</span> settings level)
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">verbose</span> (settings-verbose settings))
  (<span style="color: #4f97d7; font-weight: bold;">and</span> (real? level) (real? verbose) (&gt;= verbose level)))
</pre>
</div>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #4f97d7;">package:</span> std/make
(<span style="color: #4f97d7; font-weight: bold;">export</span> <span style="color: #4f97d7;">#t</span>)

<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">Settings: see details in doc/reference/make.md</span>
(<span style="color: #4f97d7; font-weight: bold;">defstruct</span> <span style="color: #ce537a; font-weight: bold;">settings</span>
  (srcdir libdir bindir force optimize debug static
          static-debug verbose build-deps parallelize gerbil.pkg)
  <span style="color: #4f97d7;">transparent:</span> <span style="color: #4f97d7;">#t</span> <span style="color: #4f97d7;">constructor:</span> <span style="color: #4f97d7;">:init!</span>)

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">current-make-settings</span> (make-parameter <span style="color: #4f97d7;">#f</span>))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">gerbil-build-cores</span>)
  (with-catch (<span style="color: #4f97d7; font-weight: bold;">lambda</span> (<span style="color: #4f97d7;">_</span>) (<span style="color: #4f97d7;">##</span>cpu-count)) (<span style="color: #4f97d7; font-weight: bold;">lambda</span> () (string-&gt;number (getenv <span style="color: #2d9574;">"GERBIL_BUILD_CORES"</span>)))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">read-gerbil.pkg-plist</span> srcdir)
  (with-catch
   false (<span style="color: #4f97d7; font-weight: bold;">lambda</span> () (<span style="color: #4f97d7; font-weight: bold;">call-with-input-file</span> (path-expand <span style="color: #2d9574;">"gerbil.pkg"</span> srcdir) read))))

(<span style="color: #4f97d7; font-weight: bold;">defmethod</span> <span style="color: #7590db;">{</span><span style="color: #4f97d7;">:init!</span> settings<span style="color: #7590db;">}</span>
 (<span style="color: #4f97d7; font-weight: bold;">lambda</span> (self
     <span style="color: #4f97d7;">srcdir:</span> (srcdir<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">libdir:</span> (libdir<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">bindir:</span> (bindir<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">gerbil.pkg:</span> (gxpkg<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">force:</span> (force? <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">optimize:</span> (optimize <span style="color: #4f97d7;">#t</span>) <span style="color: #4f97d7;">debug:</span> (debug <span style="color: #4f97d7; font-weight: bold;">'</span>env)
     <span style="color: #4f97d7;">static:</span> (static <span style="color: #4f97d7;">#t</span>) <span style="color: #4f97d7;">static-debug:</span> (static-debug <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">verbose:</span> (verbose <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">build-deps:</span> (build-deps<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">parallelize:</span> (parallelize<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#t</span>))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">gerbil-path</span> (getenv <span style="color: #2d9574;">"GERBIL_PATH"</span> <span style="color: #2d9574;">"~/.gerbil"</span>))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">srcdir</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> srcdir<span style="color: #4f97d7;">_</span> (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"srcdir must be specified"</span>)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">gerbil.pkg</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> gxpkg<span style="color: #4f97d7;">_</span> (read-gerbil.pkg-plist srcdir<span style="color: #4f97d7;">_</span> )))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">libdir</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> libdir<span style="color: #4f97d7;">_</span> (path-expand <span style="color: #2d9574;">"lib"</span> gerbil-path)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">bindir</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> bindir<span style="color: #4f97d7;">_</span> (path-expand <span style="color: #2d9574;">"bin"</span> gerbil-path)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">build-deps</span> (path-expand (<span style="color: #4f97d7; font-weight: bold;">or</span> build-deps<span style="color: #4f97d7;">_</span> <span style="color: #2d9574;">"build-deps"</span>) srcdir))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">parallelize</span> (<span style="color: #4f97d7; font-weight: bold;">if</span> (eq? parallelize<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#t</span>) (gerbil-build-cores) (<span style="color: #4f97d7; font-weight: bold;">or</span> parallelize<span style="color: #4f97d7;">_</span> 0)))
   (struct-instance-init!
     self
     srcdir libdir bindir force? optimize debug static static-debug verbose build-deps
     parallelize gerbil.pkg))
   <span style="color: #4f97d7;">rebind:</span> <span style="color: #4f97d7;">#t</span>)

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">settings-gerbil.pkg-pgetq</span> s k (nope <span style="color: #4f97d7;">#f</span>))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> (plist (settings-gerbil.pkg s))
    (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> plist) nope (pgetq plist k nope))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">settings-package</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> settings-gerbil.pkg-pgetq <span style="color: #4f97d7;">&lt;&gt;</span> <span style="color: #4f97d7;">package:</span>))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">settings-namespace</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> settings-gerbil.pkg-pgetq <span style="color: #4f97d7;">&lt;&gt;</span> <span style="color: #4f97d7;">namespace:</span>))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">settings-prelude</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> settings-gerbil.pkg-pgetq <span style="color: #4f97d7;">&lt;&gt;</span> <span style="color: #4f97d7;">prelude:</span>))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">settings-verbose&gt;=?</span> settings level)
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">verbose</span> (settings-verbose settings))
  (<span style="color: #4f97d7; font-weight: bold;">and</span> (real? level) (real? verbose) (&gt;= verbose level)))
</pre>
</div>

<p>
Now the expander module.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #4f97d7;">package:</span> std/make
(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:std/misc/func</span> <span style="color: #4f97d7;">:gerbil/expander/module</span> <span style="color: #4f97d7;">:std/lazy</span>)
(<span style="color: #4f97d7; font-weight: bold;">export</span> <span style="color: #4f97d7;">#t</span>)

<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">-*- Gerbil -*-</span>
<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">(C) vyzo at hackzen.org, me at drewc.ca</span>
(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:gerbil/expander/module</span> <span style="color: #4f97d7;">:std/lazy</span>)
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">prep-import-module</span>
      rpath
      <span style="color: #4f97d7;">srcdir:</span> (srcdir <span style="color: #2d9574;">"/"</span>)
      <span style="color: #4f97d7;">package:</span> (<span style="color: #4f97d7;">_</span>package <span style="color: #4f97d7;">#f</span>)
      <span style="color: #4f97d7;">id:</span> (<span style="color: #4f97d7;">_</span>id <span style="color: #4f97d7;">#f</span>)
      <span style="color: #4f97d7;">namespace:</span> (<span style="color: #4f97d7;">_</span>ns <span style="color: #4f97d7;">#f</span>)
      <span style="color: #4f97d7;">pre:</span> (<span style="color: #4f97d7;">_</span>pre <span style="color: #4f97d7;">#f</span>)
      (reload? <span style="color: #4f97d7;">#f</span>))

  (<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">import-source</span> path)
    (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">mod-path</span> (path-normalize path (<span style="color: #4f97d7; font-weight: bold;">or</span> srcdir <span style="color: #4f97d7;">#f</span>) (<span style="color: #4f97d7; font-weight: bold;">or</span> srcdir <span style="color: #2d9574;">""</span>)))

    (<span style="color: #4f97d7; font-weight: bold;">when</span> (member path (gx<span style="color: #4f97d7;">#</span>current-expander-path))
      (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"Cyclic expansion"</span> path))
    (<span style="color: #4f97d7; font-weight: bold;">parameterize</span> ((gx<span style="color: #4f97d7;">#</span>current-expander-context (gx<span style="color: #4f97d7;">#</span>core-context-root))
                   (gx<span style="color: #4f97d7;">#</span>current-expander-marks <span style="color: #7590db;">[]</span>)
                   (gx<span style="color: #4f97d7;">#</span>current-expander-phi 0)
                   (gx<span style="color: #4f97d7;">#</span>current-expander-path
                    (cons path (gx<span style="color: #4f97d7;">#</span>current-expander-path)))
                   (gx<span style="color: #4f97d7;">#</span>current-import-expander-phi <span style="color: #4f97d7;">#f</span>)
                   (gx<span style="color: #4f97d7;">#</span>current-export-expander-phi <span style="color: #4f97d7;">#f</span>))
      (<span style="color: #4f97d7; font-weight: bold;">let-values</span> (((pre id ns body)
                    (gx<span style="color: #4f97d7;">#</span>core-read-module mod-path)))
        (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-name</span> (path-strip-directory (path-strip-extension path)))
        (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-id</span>
          <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If we provide _id, use it(d)!</span>
          (<span style="color: #4f97d7; font-weight: bold;">or</span> <span style="color: #4f97d7;">_</span>id
            <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If the core module package is the same as the mod that means we could not</span>
            <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">find a package.</span>
            (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> (equal? module-name (symbol-&gt;string id))) id
              <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If we do not have a toplevel package we are the id.</span>
              (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> <span style="color: #4f97d7;">_</span>package) id
                  <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">otherwise add it as the package as a supercontainer and return</span>
                  (string-&gt;symbol (path-expand module-name (symbol-&gt;string <span style="color: #4f97d7;">_</span>package)))))))
        (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-ns</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> <span style="color: #4f97d7;">_</span>ns (<span style="color: #4f97d7; font-weight: bold;">if</span> (equal? module-name ns) (symbol-&gt;string module-id) ns)))
        (<span style="color: #4f97d7; font-weight: bold;">let*</span> ((prelude
                (<span style="color: #4f97d7; font-weight: bold;">cond</span>
                 ((gx<span style="color: #4f97d7;">#</span>prelude-context? pre) pre)
                 ((gx<span style="color: #4f97d7;">#</span>module-context? pre)
                  (gx<span style="color: #4f97d7;">#</span>core-module-&gt;prelude-context pre))
                 ((string? pre)
                  (gx<span style="color: #4f97d7;">#</span>core-module-&gt;prelude-context
                   (core-import-module pre)))
                 ((<span style="color: #4f97d7; font-weight: bold;">not</span> pre)
                  (<span style="color: #4f97d7; font-weight: bold;">or</span> (gx<span style="color: #4f97d7;">#</span>current-expander-module-prelude)
                      (gx<span style="color: #4f97d7;">#</span>make-prelude-context <span style="color: #4f97d7;">#f</span>)))
                 (<span style="color: #4f97d7; font-weight: bold;">else</span>
                  (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"Cannot import module; unknown prelude"</span> rpath pre))))
               (ctx
                (gx<span style="color: #4f97d7;">#</span>make-module-context module-id prelude module-ns path))
               (body
               (gx<span style="color: #4f97d7;">#</span>core-expand-module-begin body ctx))
               (body
                (gx<span style="color: #4f97d7;">#</span>core-quote-syntax
                 (gx<span style="color: #4f97d7;">#</span>core-cons <span style="color: #4f97d7; font-weight: bold;">'</span><span style="color: #4f97d7;">%#begin</span> body)
                 path ctx <span style="color: #7590db;">[]</span>)))
           (<span style="color: #4f97d7; font-weight: bold;">set!</span> (gx<span style="color: #4f97d7;">#</span>&amp;module-context-e ctx)
             (<span style="color: #4f97d7; font-weight: bold;">delay</span> (gx<span style="color: #4f97d7;">#</span>eval-syntax* body)))
          (<span style="color: #4f97d7; font-weight: bold;">set!</span> (gx<span style="color: #4f97d7;">#</span>&amp;module-context-code ctx)
            body)
          (hash-put! (gx<span style="color: #4f97d7;">#</span>current-expander-module-registry) path ctx)
          (hash-put! (gx<span style="color: #4f97d7;">#</span>current-expander-module-registry) id ctx)
          ctx))))

  (<span style="color: #4f97d7; font-weight: bold;">let</span> (npath (path-normalize rpath <span style="color: #4f97d7;">#f</span>))
    (<span style="color: #4f97d7; font-weight: bold;">cond</span>
     ((<span style="color: #4f97d7; font-weight: bold;">and</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> reload?)
           (hash-get (gx<span style="color: #4f97d7;">#</span>current-expander-module-registry) npath))
      <span style="color: #4f97d7;">=&gt;</span> <span style="color: #4f97d7; font-weight: bold;">values</span>)
     (<span style="color: #4f97d7; font-weight: bold;">else</span> (<span style="color: #4f97d7; font-weight: bold;">parameterize</span> ((current-directory (<span style="color: #4f97d7; font-weight: bold;">or</span> srcdir (current-directory))))
             (import-source (path-normalize rpath <span style="color: #4f97d7;">#f</span>)))))))


(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">expander-module-id</span> gx<span style="color: #4f97d7;">#</span>expander-context-id)

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">expander-module-name</span>
  (compose string-&gt;symbol path-strip-directory
           symbol-&gt;string expander-module-id))

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">expander-module-relative-library-directory</span>
  (compose path-strip-trailing-directory-separator path-directory
           symbol-&gt;string expander-module-id))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">expander-module-package</span> m)
  (<span style="color: #4f97d7; font-weight: bold;">let</span> (d (expander-module-relative-library-directory m))
    (<span style="color: #4f97d7; font-weight: bold;">if</span> (equal? <span style="color: #2d9574;">""</span> d) <span style="color: #4f97d7;">#f</span> (string-&gt;symbol d))))


(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">expander-module-namespace</span> gx<span style="color: #4f97d7;">#</span>module-context-ns)
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">expander-module-prelude</span> gx<span style="color: #4f97d7;">#</span>&amp;phi-context-super)
</pre>
</div>
</div>
</div>

<div id="outline-container-org669cb50" class="outline-4">
<h4 id="org669cb50"><code>mod</code>'s: Talking 'bout this generation</h4>
<div class="outline-text-4" id="text-org669cb50">
<p>
Time for the <code>mod</code>'s to rumble. What is a <code>mod</code>? A mod is a string specifying a
file's name and relative location.
</p>

<p>
With a <code>mod</code> we can get an <code>expander-module</code> which has an
<code>expander-module-relative-library-directory</code>.
</p>

<p>
That's what we need for <code>library-path</code>.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">library-path</span> mod ext (settings (current-make-settings)))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> (expm (mod-expander-module mod settings))
    (path-expand (path-force-extension mod ext)
                 (path-expand (expander-module-relative-library-directory expm)
                              (settings-libdir settings)))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #4f97d7;">package:</span> std/make
(<span style="color: #4f97d7; font-weight: bold;">import</span> ./expander-module <span style="color: #4f97d7;">:std/make/settings</span> <span style="color: #4f97d7;">:std/misc/func</span> <span style="color: #4f97d7;">:std/misc/path</span>)
(<span style="color: #4f97d7; font-weight: bold;">export</span> <span style="color: #4f97d7;">#t</span>)

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">source-path</span> mod ext settings)
  (path-expand (path-default-extension mod ext) (settings-srcdir settings)))

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">mod-expander-modules</span> (make-hash-table)) <span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">cache</span>
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">mod-expander-module</span> mod (settings (current-make-settings)) (reload? <span style="color: #4f97d7;">#f</span>))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> (v (hash-ref mod-expander-modules mod (void)))
    (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">and</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> (void? v)) (<span style="color: #4f97d7; font-weight: bold;">not</span> reload?)) v
        (<span style="color: #4f97d7; font-weight: bold;">let*</span> ((src (source-path mod <span style="color: #2d9574;">".ss"</span> settings))
               (m (<span style="color: #4f97d7; font-weight: bold;">and</span> (file-exists? src)
                       (prep-import-module
                        src
                        <span style="color: #4f97d7;">srcdir:</span> (settings-srcdir settings)
                        <span style="color: #4f97d7;">package:</span> (settings-package settings)
                        <span style="color: #4f97d7;">namespace:</span> (settings-namespace settings)
                        reload?))))
          (<span style="color: #4f97d7; font-weight: bold;">begin0</span> m (hash-put! mod-expander-modules mod m))))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">library-path</span> mod ext (settings (current-make-settings)))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> (expm (mod-expander-module mod settings))
    (path-expand (path-force-extension mod ext)
                 (path-expand (expander-module-relative-library-directory expm)
                              (settings-libdir settings)))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">static-file-path</span> file settings)
  (<span style="color: #4f97d7; font-weight: bold;">let*</span> ((libdir (settings-libdir settings))
         (staticdir (path-expand <span style="color: #2d9574;">"static"</span> libdir))
         (filename (path-strip-directory file)))
    (path-expand filename staticdir)))
</pre>
</div>
</div>
</div>


<div id="outline-container-org11f5adf" class="outline-4">
<h4 id="org11f5adf"><code>gxc-compile-file</code>: `make;make install`</h4>
<div class="outline-text-4" id="text-org11f5adf">
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">gsc-compile-opts</span> opts)
  (<span style="color: #4f97d7; font-weight: bold;">match</span> opts
    (<span style="color: #7590db;">[[</span>plist <span style="color: #4f97d7;">...</span><span style="color: #7590db;">]</span> . rest<span style="color: #7590db;">]</span> (listify rest))
    (<span style="color: #4f97d7;">_</span> (listify opts))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">gxc-compile-file</span> mod opts settings (invoke-gsc? <span style="color: #4f97d7;">#t</span>))
  (message <span style="color: #2d9574;">"... compile-file "</span> mod)
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">gsc-opts</span> (gsc-compile-opts opts))
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">srcpath</span> (source-path mod <span style="color: #2d9574;">".ss"</span> settings))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> ((gxc-opts
         <span style="color: #7590db;">[</span><span style="color: #4f97d7;">invoke-gsc:</span> invoke-gsc?
                      <span style="color: #4f97d7;">keep-scm:</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> invoke-gsc?)
                      <span style="color: #4f97d7;">output-dir:</span> (settings-libdir settings)
                      <span style="color: #4f97d7;">optimize:</span> (settings-optimize settings)
                      <span style="color: #4f97d7;">debug:</span> (settings-debug settings)
                      <span style="color: #4f97d7;">generate-ssxi:</span> <span style="color: #4f97d7;">#t</span>
                      <span style="color: #4f97d7;">static:</span> (settings-static settings)
                      <span style="color: #4f97d7;">verbose:</span> (settings-verbose&gt;=? settings 9)
                      (when/list gsc-opts <span style="color: #7590db;">[</span><span style="color: #4f97d7;">gsc-options:</span> gsc-opts<span style="color: #7590db;">]</span>) <span style="color: #4f97d7;">...</span><span style="color: #7590db;">]</span>))
    (compile-file srcpath gxc-opts)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaaf1637" class="outline-4">
<h4 id="orgaaf1637">bootstrap</h4>
<div class="outline-text-4" id="text-orgaaf1637">
<p>
Going to have an attempt at building that before there's a function to build it,
as we have all along.
</p>

<p>
Because we cannot build ourselves we bootstrap our build.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:std/misc/path</span> <span style="color: #4f97d7;">:std/misc/list</span> <span style="color: #4f97d7;">:gerbil/compiler</span>)

<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">Settings: see details in doc/reference/make.md</span>
(<span style="color: #4f97d7; font-weight: bold;">defstruct</span> <span style="color: #ce537a; font-weight: bold;">settings</span>
  (srcdir libdir bindir force optimize debug static
          static-debug verbose build-deps parallelize gerbil.pkg)
  <span style="color: #4f97d7;">transparent:</span> <span style="color: #4f97d7;">#t</span> <span style="color: #4f97d7;">constructor:</span> <span style="color: #4f97d7;">:init!</span>)

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">current-make-settings</span> (make-parameter <span style="color: #4f97d7;">#f</span>))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">settings-verbose&gt;=?</span> settings level)
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">verbose</span> (settings-verbose settings))
  (<span style="color: #4f97d7; font-weight: bold;">and</span> (real? level) (real? verbose) (&gt;= verbose level)))
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">gerbil-build-cores</span>)
  (with-catch (<span style="color: #4f97d7; font-weight: bold;">lambda</span> (<span style="color: #4f97d7;">_</span>) (<span style="color: #4f97d7;">##</span>cpu-count)) (<span style="color: #4f97d7; font-weight: bold;">lambda</span> () (string-&gt;number (getenv <span style="color: #2d9574;">"GERBIL_BUILD_CORES"</span>)))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">read-gerbil.pkg-plist</span> srcdir)
  (with-catch
   false (<span style="color: #4f97d7; font-weight: bold;">lambda</span> () (<span style="color: #4f97d7; font-weight: bold;">call-with-input-file</span> (path-expand <span style="color: #2d9574;">"gerbil.pkg"</span> srcdir) read))))

(<span style="color: #4f97d7; font-weight: bold;">defmethod</span> <span style="color: #7590db;">{</span><span style="color: #4f97d7;">:init!</span> settings<span style="color: #7590db;">}</span>
 (<span style="color: #4f97d7; font-weight: bold;">lambda</span> (self
     <span style="color: #4f97d7;">srcdir:</span> (srcdir<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">libdir:</span> (libdir<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">bindir:</span> (bindir<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">gerbil.pkg:</span> (gxpkg<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">force:</span> (force? <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">optimize:</span> (optimize <span style="color: #4f97d7;">#t</span>) <span style="color: #4f97d7;">debug:</span> (debug <span style="color: #4f97d7; font-weight: bold;">'</span>env)
     <span style="color: #4f97d7;">static:</span> (static <span style="color: #4f97d7;">#t</span>) <span style="color: #4f97d7;">static-debug:</span> (static-debug <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">verbose:</span> (verbose <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">build-deps:</span> (build-deps<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">parallelize:</span> (parallelize<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#t</span>))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">gerbil-path</span> (getenv <span style="color: #2d9574;">"GERBIL_PATH"</span> <span style="color: #2d9574;">"~/.gerbil"</span>))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">srcdir</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> srcdir<span style="color: #4f97d7;">_</span> (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"srcdir must be specified"</span>)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">gerbil.pkg</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> gxpkg<span style="color: #4f97d7;">_</span> (read-gerbil.pkg-plist srcdir<span style="color: #4f97d7;">_</span> )))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">libdir</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> libdir<span style="color: #4f97d7;">_</span> (path-expand <span style="color: #2d9574;">"lib"</span> gerbil-path)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">bindir</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> bindir<span style="color: #4f97d7;">_</span> (path-expand <span style="color: #2d9574;">"bin"</span> gerbil-path)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">build-deps</span> (path-expand (<span style="color: #4f97d7; font-weight: bold;">or</span> build-deps<span style="color: #4f97d7;">_</span> <span style="color: #2d9574;">"build-deps"</span>) srcdir))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">parallelize</span> (<span style="color: #4f97d7; font-weight: bold;">if</span> (eq? parallelize<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#t</span>) (gerbil-build-cores) (<span style="color: #4f97d7; font-weight: bold;">or</span> parallelize<span style="color: #4f97d7;">_</span> 0)))
   (struct-instance-init!
     self
     srcdir libdir bindir force? optimize debug static static-debug verbose build-deps
     parallelize gerbil.pkg))
   <span style="color: #4f97d7;">rebind:</span> <span style="color: #4f97d7;">#t</span>)

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">settings-gerbil.pkg-pgetq</span> s k (nope <span style="color: #4f97d7;">#f</span>))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> (plist (settings-gerbil.pkg s))
    (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> plist) nope (pgetq plist k nope))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">settings-package</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> settings-gerbil.pkg-pgetq <span style="color: #4f97d7;">&lt;&gt;</span> <span style="color: #4f97d7;">package:</span>))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">settings-namespace</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> settings-gerbil.pkg-pgetq <span style="color: #4f97d7;">&lt;&gt;</span> <span style="color: #4f97d7;">namespace:</span>))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">settings-prelude</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> settings-gerbil.pkg-pgetq <span style="color: #4f97d7;">&lt;&gt;</span> <span style="color: #4f97d7;">prelude:</span>))

<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">-*- Gerbil -*-</span>
<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">(C) vyzo at hackzen.org, me at drewc.ca</span>
(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:gerbil/expander/module</span> <span style="color: #4f97d7;">:std/lazy</span>)
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">prep-import-module</span>
      rpath
      <span style="color: #4f97d7;">srcdir:</span> (srcdir <span style="color: #2d9574;">"/"</span>)
      <span style="color: #4f97d7;">package:</span> (<span style="color: #4f97d7;">_</span>package <span style="color: #4f97d7;">#f</span>)
      <span style="color: #4f97d7;">id:</span> (<span style="color: #4f97d7;">_</span>id <span style="color: #4f97d7;">#f</span>)
      <span style="color: #4f97d7;">namespace:</span> (<span style="color: #4f97d7;">_</span>ns <span style="color: #4f97d7;">#f</span>)
      <span style="color: #4f97d7;">pre:</span> (<span style="color: #4f97d7;">_</span>pre <span style="color: #4f97d7;">#f</span>)
      (reload? <span style="color: #4f97d7;">#f</span>))

  (<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">import-source</span> path)
    (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">mod-path</span> (path-normalize path (<span style="color: #4f97d7; font-weight: bold;">or</span> srcdir <span style="color: #4f97d7;">#f</span>) (<span style="color: #4f97d7; font-weight: bold;">or</span> srcdir <span style="color: #2d9574;">""</span>)))

    (<span style="color: #4f97d7; font-weight: bold;">when</span> (member path (gx<span style="color: #4f97d7;">#</span>current-expander-path))
      (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"Cyclic expansion"</span> path))
    (<span style="color: #4f97d7; font-weight: bold;">parameterize</span> ((gx<span style="color: #4f97d7;">#</span>current-expander-context (gx<span style="color: #4f97d7;">#</span>core-context-root))
                   (gx<span style="color: #4f97d7;">#</span>current-expander-marks <span style="color: #7590db;">[]</span>)
                   (gx<span style="color: #4f97d7;">#</span>current-expander-phi 0)
                   (gx<span style="color: #4f97d7;">#</span>current-expander-path
                    (cons path (gx<span style="color: #4f97d7;">#</span>current-expander-path)))
                   (gx<span style="color: #4f97d7;">#</span>current-import-expander-phi <span style="color: #4f97d7;">#f</span>)
                   (gx<span style="color: #4f97d7;">#</span>current-export-expander-phi <span style="color: #4f97d7;">#f</span>))
      (<span style="color: #4f97d7; font-weight: bold;">let-values</span> (((pre id ns body)
                    (gx<span style="color: #4f97d7;">#</span>core-read-module mod-path)))
        (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-name</span> (path-strip-directory (path-strip-extension path)))
        (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-id</span>
          <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If we provide _id, use it(d)!</span>
          (<span style="color: #4f97d7; font-weight: bold;">or</span> <span style="color: #4f97d7;">_</span>id
            <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If the core module package is the same as the mod that means we could not</span>
            <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">find a package.</span>
            (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> (equal? module-name (symbol-&gt;string id))) id
              <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If we do not have a toplevel package we are the id.</span>
              (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> <span style="color: #4f97d7;">_</span>package) id
                  <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">otherwise add it as the package as a supercontainer and return</span>
                  (string-&gt;symbol (path-expand module-name (symbol-&gt;string <span style="color: #4f97d7;">_</span>package)))))))
        (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-ns</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> <span style="color: #4f97d7;">_</span>ns (<span style="color: #4f97d7; font-weight: bold;">if</span> (equal? module-name ns) (symbol-&gt;string module-id) ns)))
        (<span style="color: #4f97d7; font-weight: bold;">let*</span> ((prelude
                (<span style="color: #4f97d7; font-weight: bold;">cond</span>
                 ((gx<span style="color: #4f97d7;">#</span>prelude-context? pre) pre)
                 ((gx<span style="color: #4f97d7;">#</span>module-context? pre)
                  (gx<span style="color: #4f97d7;">#</span>core-module-&gt;prelude-context pre))
                 ((string? pre)
                  (gx<span style="color: #4f97d7;">#</span>core-module-&gt;prelude-context
                   (core-import-module pre)))
                 ((<span style="color: #4f97d7; font-weight: bold;">not</span> pre)
                  (<span style="color: #4f97d7; font-weight: bold;">or</span> (gx<span style="color: #4f97d7;">#</span>current-expander-module-prelude)
                      (gx<span style="color: #4f97d7;">#</span>make-prelude-context <span style="color: #4f97d7;">#f</span>)))
                 (<span style="color: #4f97d7; font-weight: bold;">else</span>
                  (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"Cannot import module; unknown prelude"</span> rpath pre))))
               (ctx
                (gx<span style="color: #4f97d7;">#</span>make-module-context module-id prelude module-ns path))
               (body
               (gx<span style="color: #4f97d7;">#</span>core-expand-module-begin body ctx))
               (body
                (gx<span style="color: #4f97d7;">#</span>core-quote-syntax
                 (gx<span style="color: #4f97d7;">#</span>core-cons <span style="color: #4f97d7; font-weight: bold;">'</span><span style="color: #4f97d7;">%#begin</span> body)
                 path ctx <span style="color: #7590db;">[]</span>)))
           (<span style="color: #4f97d7; font-weight: bold;">set!</span> (gx<span style="color: #4f97d7;">#</span>&amp;module-context-e ctx)
             (<span style="color: #4f97d7; font-weight: bold;">delay</span> (gx<span style="color: #4f97d7;">#</span>eval-syntax* body)))
          (<span style="color: #4f97d7; font-weight: bold;">set!</span> (gx<span style="color: #4f97d7;">#</span>&amp;module-context-code ctx)
            body)
          (hash-put! (gx<span style="color: #4f97d7;">#</span>current-expander-module-registry) path ctx)
          (hash-put! (gx<span style="color: #4f97d7;">#</span>current-expander-module-registry) id ctx)
          ctx))))

  (<span style="color: #4f97d7; font-weight: bold;">let</span> (npath (path-normalize rpath <span style="color: #4f97d7;">#f</span>))
    (<span style="color: #4f97d7; font-weight: bold;">cond</span>
     ((<span style="color: #4f97d7; font-weight: bold;">and</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> reload?)
           (hash-get (gx<span style="color: #4f97d7;">#</span>current-expander-module-registry) npath))
      <span style="color: #4f97d7;">=&gt;</span> <span style="color: #4f97d7; font-weight: bold;">values</span>)
     (<span style="color: #4f97d7; font-weight: bold;">else</span> (<span style="color: #4f97d7; font-weight: bold;">parameterize</span> ((current-directory (<span style="color: #4f97d7; font-weight: bold;">or</span> srcdir (current-directory))))
             (import-source (path-normalize rpath <span style="color: #4f97d7;">#f</span>)))))))


(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">source-path</span> mod ext settings)
  (path-expand (path-default-extension mod ext) (settings-srcdir settings)))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">force-outputs</span>) (force-output (current-error-port)) (force-output)) <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">move to std/misc/ports ?</span>
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">message</span> . lst) (<span style="color: #4f97d7; font-weight: bold;">apply</span> displayln lst) (force-outputs)) <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">move to std/misc/ports ?</span>

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">gsc-compile-opts</span> opts)
  (<span style="color: #4f97d7; font-weight: bold;">match</span> opts
    (<span style="color: #7590db;">[[</span>plist <span style="color: #4f97d7;">...</span><span style="color: #7590db;">]</span> . rest<span style="color: #7590db;">]</span> (listify rest))
    (<span style="color: #4f97d7;">_</span> (listify opts))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">gxc-compile-file</span> mod opts settings (invoke-gsc? <span style="color: #4f97d7;">#t</span>))
  (message <span style="color: #2d9574;">"... compile-file "</span> mod)
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">gsc-opts</span> (gsc-compile-opts opts))
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">srcpath</span> (source-path mod <span style="color: #2d9574;">".ss"</span> settings))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> ((gxc-opts
         <span style="color: #7590db;">[</span><span style="color: #4f97d7;">invoke-gsc:</span> invoke-gsc?
                      <span style="color: #4f97d7;">keep-scm:</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> invoke-gsc?)
                      <span style="color: #4f97d7;">output-dir:</span> (settings-libdir settings)
                      <span style="color: #4f97d7;">optimize:</span> (settings-optimize settings)
                      <span style="color: #4f97d7;">debug:</span> (settings-debug settings)
                      <span style="color: #4f97d7;">generate-ssxi:</span> <span style="color: #4f97d7;">#t</span>
                      <span style="color: #4f97d7;">static:</span> (settings-static settings)
                      <span style="color: #4f97d7;">verbose:</span> (settings-verbose&gt;=? settings 9)
                      (when/list gsc-opts <span style="color: #7590db;">[</span><span style="color: #4f97d7;">gsc-options:</span> gsc-opts<span style="color: #7590db;">]</span>) <span style="color: #4f97d7;">...</span><span style="color: #7590db;">]</span>))
    (compile-file srcpath gxc-opts)))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">set-loadpath</span> settings)
  (<span style="color: #4f97d7; font-weight: bold;">let*</span> ((loadpath (getenv <span style="color: #2d9574;">"GERBIL_LOAD_PATH"</span> <span style="color: #4f97d7;">#f</span>))
         (loapath (<span style="color: #4f97d7; font-weight: bold;">if</span> loadpath (string-append loadpath <span style="color: #2d9574;">":"</span>) <span style="color: #2d9574;">""</span>))
         (loadpath (string-append (<span style="color: #4f97d7; font-weight: bold;">or</span> loadpath <span style="color: #2d9574;">""</span>) (settings-srcdir settings))))
    (setenv <span style="color: #2d9574;">"GERBIL_LOAD_PATH"</span> loadpath)))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">prep-mod</span> mod settings (reload? <span style="color: #4f97d7;">#f</span>))
  (prep-import-module                   <span style="color: #2aa1ae; background-color: #292e34;">;</span>
   (source-path mod <span style="color: #2d9574;">".ss"</span> settings)
   <span style="color: #4f97d7;">srcdir:</span> (settings-srcdir settings)
   <span style="color: #4f97d7;">package:</span> (settings-package settings)
   <span style="color: #4f97d7;">namespace:</span> (settings-namespace settings)
   reload?))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">build-mods</span> mods (srcdir (path-normalize (path-directory (this-source-file)))))
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">settings</span> (make-settings <span style="color: #4f97d7;">srcdir:</span> srcdir <span style="color: #4f97d7;">verbose:</span> <span style="color: #4f97d7;">#t</span>))
  (set-loadpath settings)

  (<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">build-mod</span> mod) (message <span style="color: #2d9574;">"building "</span> mod)
    (prep-mod mod settings)
    (gxc-compile-file mod <span style="color: #7590db;">[]</span> settings))


  (message <span style="color: #2d9574;">"Builings Mods "</span> mods)

  (<span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #bc6ec5; font-weight: bold;">build</span> ((ms mods))
    (<span style="color: #4f97d7; font-weight: bold;">unless</span> (null? ms)
      (build-mod (car ms)) (build (cdr ms)))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme">
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">+this-file+</span> (this-source-file))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">+this-srcdir+</span> (path-normalize (path-directory +this-file+)))

(current-directory +this-srcdir+)
(load <span style="color: #2d9574;">"test-bootstrap1.ss"</span>)

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">mods</span>
  <span style="color: #4f97d7; font-weight: bold;">'</span>(<span style="color: #2d9574;">"make/base"</span> <span style="color: #2d9574;">"make/settings"</span> <span style="color: #2d9574;">"make/expander-module"</span> <span style="color: #2d9574;">"make/mod"</span>))

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">+mod-src-dir+</span> (path-expand <span style="color: #2d9574;">".."</span> +this-srcdir+ ))

(current-directory +mod-src-dir+)

(message <span style="color: #2d9574;">"srcdir "</span> +mod-src-dir+)

(build-mods mods +mod-src-dir+)

</pre>
</div>


<div class="org-src-container">
<pre class="src src-shell">rm -rf ~/.gerbil/lib/std/make/*
~/src/gerbil-build/test/build1.ss
</pre>
</div>


<div class="org-src-container">
<pre class="src src-shell">srcdir /home/user/src/gerbil-build/test/..
Builings Mods <span style="color: #4f97d7;">(</span>make/base make/settings make/expander-module make/mod<span style="color: #4f97d7;">)</span>
building make/base
... compile-file make/base
building make/settings
... compile-file make/settings
building make/expander-module
... compile-file make/expander-module
building make/mod
... compile-file make/mod
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org75674b0" class="outline-3">
<h3 id="org75674b0">Step 3: Release pre-0.1 build</h3>
<div class="outline-text-3" id="text-org75674b0">
<p>
Now that I have it working to build itself it's time to release it. First
compile all the files using ourself. 
</p>

<p>
The <code>make/boostrap</code> module has the bare minimum needed to make something.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #4f97d7;">package:</span> std/make
<span style="color: #4f97d7;">namespace:</span> std/make/bootstrap
(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:std/misc/path</span> <span style="color: #4f97d7;">:std/misc/list</span> <span style="color: #4f97d7;">:gerbil/compiler</span> <span style="color: #4f97d7;">:gerbil/gambit/ports</span>)
(<span style="color: #4f97d7; font-weight: bold;">export</span> <span style="color: #4f97d7;">#t</span>)

<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">Settings: see details in doc/reference/make.md</span>
(<span style="color: #4f97d7; font-weight: bold;">defstruct</span> <span style="color: #ce537a; font-weight: bold;">settings</span>
  (srcdir libdir bindir force optimize debug static
          static-debug verbose build-deps parallelize gerbil.pkg)
  <span style="color: #4f97d7;">transparent:</span> <span style="color: #4f97d7;">#t</span> <span style="color: #4f97d7;">constructor:</span> <span style="color: #4f97d7;">:init!</span>)

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">current-make-settings</span> (make-parameter <span style="color: #4f97d7;">#f</span>))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">settings-verbose&gt;=?</span> settings level)
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">verbose</span> (settings-verbose settings))
  (<span style="color: #4f97d7; font-weight: bold;">and</span> (real? level) (real? verbose) (&gt;= verbose level)))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">gerbil-build-cores</span>)
  (with-catch (<span style="color: #4f97d7; font-weight: bold;">lambda</span> (<span style="color: #4f97d7;">_</span>) (<span style="color: #4f97d7;">##</span>cpu-count)) (<span style="color: #4f97d7; font-weight: bold;">lambda</span> () (string-&gt;number (getenv <span style="color: #2d9574;">"GERBIL_BUILD_CORES"</span>)))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">read-gerbil.pkg-plist</span> srcdir)
  (with-catch
   false (<span style="color: #4f97d7; font-weight: bold;">lambda</span> () (<span style="color: #4f97d7; font-weight: bold;">call-with-input-file</span> (path-expand <span style="color: #2d9574;">"gerbil.pkg"</span> srcdir) read))))

(<span style="color: #4f97d7; font-weight: bold;">defmethod</span> <span style="color: #7590db;">{</span><span style="color: #4f97d7;">:init!</span> settings<span style="color: #7590db;">}</span>
 (<span style="color: #4f97d7; font-weight: bold;">lambda</span> (self
     <span style="color: #4f97d7;">srcdir:</span> (srcdir<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">libdir:</span> (libdir<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">bindir:</span> (bindir<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">gerbil.pkg:</span> (gxpkg<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">force:</span> (force? <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">optimize:</span> (optimize <span style="color: #4f97d7;">#t</span>) <span style="color: #4f97d7;">debug:</span> (debug <span style="color: #4f97d7; font-weight: bold;">'</span>env)
     <span style="color: #4f97d7;">static:</span> (static <span style="color: #4f97d7;">#t</span>) <span style="color: #4f97d7;">static-debug:</span> (static-debug <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">verbose:</span> (verbose <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">build-deps:</span> (build-deps<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">parallelize:</span> (parallelize<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#t</span>))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">gerbil-path</span> (getenv <span style="color: #2d9574;">"GERBIL_PATH"</span> <span style="color: #2d9574;">"~/.gerbil"</span>))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">srcdir</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> srcdir<span style="color: #4f97d7;">_</span> (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"srcdir must be specified"</span>)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">gerbil.pkg</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> gxpkg<span style="color: #4f97d7;">_</span> (read-gerbil.pkg-plist srcdir<span style="color: #4f97d7;">_</span> )))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">libdir</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> libdir<span style="color: #4f97d7;">_</span> (path-expand <span style="color: #2d9574;">"lib"</span> gerbil-path)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">bindir</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> bindir<span style="color: #4f97d7;">_</span> (path-expand <span style="color: #2d9574;">"bin"</span> gerbil-path)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">build-deps</span> (path-expand (<span style="color: #4f97d7; font-weight: bold;">or</span> build-deps<span style="color: #4f97d7;">_</span> <span style="color: #2d9574;">"build-deps"</span>) srcdir))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">parallelize</span> (<span style="color: #4f97d7; font-weight: bold;">if</span> (eq? parallelize<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#t</span>) (gerbil-build-cores) (<span style="color: #4f97d7; font-weight: bold;">or</span> parallelize<span style="color: #4f97d7;">_</span> 0)))
   (struct-instance-init!
     self
     srcdir libdir bindir force? optimize debug static static-debug verbose build-deps
     parallelize gerbil.pkg))
   <span style="color: #4f97d7;">rebind:</span> <span style="color: #4f97d7;">#t</span>)

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">settings-gerbil.pkg-pgetq</span> s k (nope <span style="color: #4f97d7;">#f</span>))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> (plist (settings-gerbil.pkg s))
    (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> plist) nope (pgetq plist k nope))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">settings-package</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> settings-gerbil.pkg-pgetq <span style="color: #4f97d7;">&lt;&gt;</span> <span style="color: #4f97d7;">package:</span>))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">settings-namespace</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> settings-gerbil.pkg-pgetq <span style="color: #4f97d7;">&lt;&gt;</span> <span style="color: #4f97d7;">namespace:</span>))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">settings-prelude</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> settings-gerbil.pkg-pgetq <span style="color: #4f97d7;">&lt;&gt;</span> <span style="color: #4f97d7;">prelude:</span>))

<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">-*- Gerbil -*-</span>
<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">(C) vyzo at hackzen.org, me at drewc.ca</span>
(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:gerbil/expander/module</span> <span style="color: #4f97d7;">:std/lazy</span>)
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">prep-import-module</span>
      rpath
      <span style="color: #4f97d7;">srcdir:</span> (srcdir <span style="color: #2d9574;">"/"</span>)
      <span style="color: #4f97d7;">package:</span> (<span style="color: #4f97d7;">_</span>package <span style="color: #4f97d7;">#f</span>)
      <span style="color: #4f97d7;">id:</span> (<span style="color: #4f97d7;">_</span>id <span style="color: #4f97d7;">#f</span>)
      <span style="color: #4f97d7;">namespace:</span> (<span style="color: #4f97d7;">_</span>ns <span style="color: #4f97d7;">#f</span>)
      <span style="color: #4f97d7;">pre:</span> (<span style="color: #4f97d7;">_</span>pre <span style="color: #4f97d7;">#f</span>)
      (reload? <span style="color: #4f97d7;">#f</span>))

  (<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">import-source</span> path)
    (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">mod-path</span> (path-normalize path (<span style="color: #4f97d7; font-weight: bold;">or</span> srcdir <span style="color: #4f97d7;">#f</span>) (<span style="color: #4f97d7; font-weight: bold;">or</span> srcdir <span style="color: #2d9574;">""</span>)))

    (<span style="color: #4f97d7; font-weight: bold;">when</span> (member path (gx<span style="color: #4f97d7;">#</span>current-expander-path))
      (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"Cyclic expansion"</span> path))
    (<span style="color: #4f97d7; font-weight: bold;">parameterize</span> ((gx<span style="color: #4f97d7;">#</span>current-expander-context (gx<span style="color: #4f97d7;">#</span>core-context-root))
                   (gx<span style="color: #4f97d7;">#</span>current-expander-marks <span style="color: #7590db;">[]</span>)
                   (gx<span style="color: #4f97d7;">#</span>current-expander-phi 0)
                   (gx<span style="color: #4f97d7;">#</span>current-expander-path
                    (cons path (gx<span style="color: #4f97d7;">#</span>current-expander-path)))
                   (gx<span style="color: #4f97d7;">#</span>current-import-expander-phi <span style="color: #4f97d7;">#f</span>)
                   (gx<span style="color: #4f97d7;">#</span>current-export-expander-phi <span style="color: #4f97d7;">#f</span>))
      (<span style="color: #4f97d7; font-weight: bold;">let-values</span> (((pre id ns body)
                    (gx<span style="color: #4f97d7;">#</span>core-read-module mod-path)))
        (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-name</span> (path-strip-directory (path-strip-extension path)))
        (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-id</span>
          <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If we provide _id, use it(d)!</span>
          (<span style="color: #4f97d7; font-weight: bold;">or</span> <span style="color: #4f97d7;">_</span>id
            <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If the core module package is the same as the mod that means we could not</span>
            <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">find a package.</span>
            (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> (equal? module-name (symbol-&gt;string id))) id
              <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If we do not have a toplevel package we are the id.</span>
              (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> <span style="color: #4f97d7;">_</span>package) id
                  <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">otherwise add it as the package as a supercontainer and return</span>
                  (string-&gt;symbol (path-expand module-name (symbol-&gt;string <span style="color: #4f97d7;">_</span>package)))))))
        (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-ns</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> <span style="color: #4f97d7;">_</span>ns (<span style="color: #4f97d7; font-weight: bold;">if</span> (equal? module-name ns) (symbol-&gt;string module-id) ns)))
        (<span style="color: #4f97d7; font-weight: bold;">let*</span> ((prelude
                (<span style="color: #4f97d7; font-weight: bold;">cond</span>
                 ((gx<span style="color: #4f97d7;">#</span>prelude-context? pre) pre)
                 ((gx<span style="color: #4f97d7;">#</span>module-context? pre)
                  (gx<span style="color: #4f97d7;">#</span>core-module-&gt;prelude-context pre))
                 ((string? pre)
                  (gx<span style="color: #4f97d7;">#</span>core-module-&gt;prelude-context
                   (core-import-module pre)))
                 ((<span style="color: #4f97d7; font-weight: bold;">not</span> pre)
                  (<span style="color: #4f97d7; font-weight: bold;">or</span> (gx<span style="color: #4f97d7;">#</span>current-expander-module-prelude)
                      (gx<span style="color: #4f97d7;">#</span>make-prelude-context <span style="color: #4f97d7;">#f</span>)))
                 (<span style="color: #4f97d7; font-weight: bold;">else</span>
                  (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"Cannot import module; unknown prelude"</span> rpath pre))))
               (ctx
                (gx<span style="color: #4f97d7;">#</span>make-module-context module-id prelude module-ns path))
               (body
               (gx<span style="color: #4f97d7;">#</span>core-expand-module-begin body ctx))
               (body
                (gx<span style="color: #4f97d7;">#</span>core-quote-syntax
                 (gx<span style="color: #4f97d7;">#</span>core-cons <span style="color: #4f97d7; font-weight: bold;">'</span><span style="color: #4f97d7;">%#begin</span> body)
                 path ctx <span style="color: #7590db;">[]</span>)))
           (<span style="color: #4f97d7; font-weight: bold;">set!</span> (gx<span style="color: #4f97d7;">#</span>&amp;module-context-e ctx)
             (<span style="color: #4f97d7; font-weight: bold;">delay</span> (gx<span style="color: #4f97d7;">#</span>eval-syntax* body)))
          (<span style="color: #4f97d7; font-weight: bold;">set!</span> (gx<span style="color: #4f97d7;">#</span>&amp;module-context-code ctx)
            body)
          (hash-put! (gx<span style="color: #4f97d7;">#</span>current-expander-module-registry) path ctx)
          (hash-put! (gx<span style="color: #4f97d7;">#</span>current-expander-module-registry) id ctx)
          ctx))))

  (<span style="color: #4f97d7; font-weight: bold;">let</span> (npath (path-normalize rpath <span style="color: #4f97d7;">#f</span>))
    (<span style="color: #4f97d7; font-weight: bold;">cond</span>
     ((<span style="color: #4f97d7; font-weight: bold;">and</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> reload?)
           (hash-get (gx<span style="color: #4f97d7;">#</span>current-expander-module-registry) npath))
      <span style="color: #4f97d7;">=&gt;</span> <span style="color: #4f97d7; font-weight: bold;">values</span>)
     (<span style="color: #4f97d7; font-weight: bold;">else</span> (<span style="color: #4f97d7; font-weight: bold;">parameterize</span> ((current-directory (<span style="color: #4f97d7; font-weight: bold;">or</span> srcdir (current-directory))))
             (import-source (path-normalize rpath <span style="color: #4f97d7;">#f</span>)))))))


(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">source-path</span> mod ext settings)
  (path-expand (path-default-extension mod ext) (settings-srcdir settings)))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">force-outputs</span>) (force-output (current-error-port)) (force-output)) <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">move to std/misc/ports ?</span>
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">message</span> . lst) (<span style="color: #4f97d7; font-weight: bold;">apply</span> displayln lst) (force-outputs)) <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">move to std/misc/ports ?</span>

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">gsc-compile-opts</span> opts)
  (<span style="color: #4f97d7; font-weight: bold;">match</span> opts
    (<span style="color: #7590db;">[[</span>plist <span style="color: #4f97d7;">...</span><span style="color: #7590db;">]</span> . rest<span style="color: #7590db;">]</span> (listify rest))
    (<span style="color: #4f97d7;">_</span> (listify opts))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">gxc-compile-file</span> mod opts settings (invoke-gsc? <span style="color: #4f97d7;">#t</span>))
  (message <span style="color: #2d9574;">"... compile-file "</span> mod)
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">gsc-opts</span> (gsc-compile-opts opts))
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">srcpath</span> (source-path mod <span style="color: #2d9574;">".ss"</span> settings))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> ((gxc-opts
         <span style="color: #7590db;">[</span><span style="color: #4f97d7;">invoke-gsc:</span> invoke-gsc?
                      <span style="color: #4f97d7;">keep-scm:</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> invoke-gsc?)
                      <span style="color: #4f97d7;">output-dir:</span> (settings-libdir settings)
                      <span style="color: #4f97d7;">optimize:</span> (settings-optimize settings)
                      <span style="color: #4f97d7;">debug:</span> (settings-debug settings)
                      <span style="color: #4f97d7;">generate-ssxi:</span> <span style="color: #4f97d7;">#t</span>
                      <span style="color: #4f97d7;">static:</span> (settings-static settings)
                      <span style="color: #4f97d7;">verbose:</span> (settings-verbose&gt;=? settings 9)
                      (when/list gsc-opts <span style="color: #7590db;">[</span><span style="color: #4f97d7;">gsc-options:</span> gsc-opts<span style="color: #7590db;">]</span>) <span style="color: #4f97d7;">...</span><span style="color: #7590db;">]</span>))
    (compile-file srcpath gxc-opts)))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">set-loadpath</span> settings)
  (<span style="color: #4f97d7; font-weight: bold;">let*</span> ((loadpath (getenv <span style="color: #2d9574;">"GERBIL_LOAD_PATH"</span> <span style="color: #4f97d7;">#f</span>))
         (loapath (<span style="color: #4f97d7; font-weight: bold;">if</span> loadpath (string-append loadpath <span style="color: #2d9574;">":"</span>) <span style="color: #2d9574;">""</span>))
         (loadpath (string-append (<span style="color: #4f97d7; font-weight: bold;">or</span> loadpath <span style="color: #2d9574;">""</span>) (settings-srcdir settings))))
    (setenv <span style="color: #2d9574;">"GERBIL_LOAD_PATH"</span> loadpath)))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">prep-mod</span> mod settings (reload? <span style="color: #4f97d7;">#f</span>))
  (prep-import-module                   <span style="color: #2aa1ae; background-color: #292e34;">;</span>
   (source-path mod <span style="color: #2d9574;">".ss"</span> settings)
   <span style="color: #4f97d7;">srcdir:</span> (settings-srcdir settings)
   <span style="color: #4f97d7;">package:</span> (settings-package settings)
   <span style="color: #4f97d7;">namespace:</span> (settings-namespace settings)
   reload?))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">bootstrap-make</span> mods srcdir)
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">settings</span> (make-settings <span style="color: #4f97d7;">srcdir:</span> srcdir <span style="color: #4f97d7;">verbose:</span> 10))
  (set-loadpath settings)

  (<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">build-mod</span> mod) (message <span style="color: #2d9574;">"Bootstrap building "</span> mod)
    (prep-mod mod settings)
    (gxc-compile-file mod <span style="color: #7590db;">[]</span> settings))


  (<span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #bc6ec5; font-weight: bold;">build</span> ((ms mods))
    (<span style="color: #4f97d7; font-weight: bold;">unless</span> (null? ms)
      (build-mod (car ms)) (build (cdr ms)))))
</pre>
</div>
</div>

<ul class="org-ul">
<li><a id="orga8daa92"></a><code>make/gsc</code>: The Gambit compiler<br />
<div class="outline-text-5" id="text-orga8daa92">
<p>
There's one function that belongs here.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #4f97d7;">package:</span> std/make
(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:std/misc/list</span>)
(<span style="color: #4f97d7; font-weight: bold;">export</span> gsc-compile-opts)
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">gsc-compile-opts</span> opts)
  (<span style="color: #4f97d7; font-weight: bold;">match</span> opts
    (<span style="color: #7590db;">[[</span>plist <span style="color: #4f97d7;">...</span><span style="color: #7590db;">]</span> . rest<span style="color: #7590db;">]</span> (listify rest))
    (<span style="color: #4f97d7;">_</span> (listify opts))))
</pre>
</div>
</div>
</li>


<li><a id="orgc406c9e"></a><code>make/gxc</code>: The gerbil compiler<br />
<div class="outline-text-5" id="text-orgc406c9e">
<p>
<a href="#gxc_outputs_begin">Now,</a> it seems that the entire reason I started this was an error that may get
taken care of by redefining <code>gxc-outputs</code>. Still not quite done as I have no
idea where <code>static-path</code> is actually built or used, but that matters not for
this release.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">gxc-outputs</span> mod opts settings)
  <span style="color: #7590db;">[</span>(library-path mod <span style="color: #2d9574;">".ssi"</span> settings)
  <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">(when/list (settings-static settings) [(static-path mod settings)]) ...</span>
  <span style="color: #7590db;">]</span>)
</pre>
</div>


<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #4f97d7;">package:</span> std/make
(<span style="color: #4f97d7; font-weight: bold;">import</span> ./base ./settings ./mod ./gsc <span style="color: #4f97d7;">:std/misc/list</span> <span style="color: #4f97d7;">:gerbil/compiler</span>)
(<span style="color: #4f97d7; font-weight: bold;">export</span> gxc-compile gxc-outputs)

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">gxc-outputs</span> mod opts settings)
  <span style="color: #7590db;">[</span>(library-path mod <span style="color: #2d9574;">".ssi"</span> settings)
  <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">(when/list (settings-static settings) [(static-path mod settings)]) ...</span>
  <span style="color: #7590db;">]</span>)

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">gxc-compile-file</span> mod opts settings (invoke-gsc? <span style="color: #4f97d7;">#t</span>))
  (message <span style="color: #2d9574;">"... compile-file "</span> mod)
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">gsc-opts</span> (gsc-compile-opts opts))
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">srcpath</span> (source-path mod <span style="color: #2d9574;">".ss"</span> settings))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> ((gxc-opts
         <span style="color: #7590db;">[</span><span style="color: #4f97d7;">invoke-gsc:</span> invoke-gsc?
                      <span style="color: #4f97d7;">keep-scm:</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> invoke-gsc?)
                      <span style="color: #4f97d7;">output-dir:</span> (settings-libdir settings)
                      <span style="color: #4f97d7;">optimize:</span> (settings-optimize settings)
                      <span style="color: #4f97d7;">debug:</span> (settings-debug settings)
                      <span style="color: #4f97d7;">generate-ssxi:</span> <span style="color: #4f97d7;">#t</span>
                      <span style="color: #4f97d7;">static:</span> (settings-static settings)
                      <span style="color: #4f97d7;">verbose:</span> (settings-verbose&gt;=? settings 9)
                      (when/list gsc-opts <span style="color: #7590db;">[</span><span style="color: #4f97d7;">gsc-options:</span> gsc-opts<span style="color: #7590db;">]</span>) <span style="color: #4f97d7;">...</span><span style="color: #7590db;">]</span>))
    (compile-file srcpath gxc-opts)))

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">gxc-compile</span> gxc-compile-file)
</pre>
</div>
</div>
</li>

<li><a id="orgfc35946"></a><code>make/spec</code>: Specifications<br />
<div class="outline-text-5" id="text-orgfc35946">
<p>
Essentially we want a short form syntax for making <b>make/makefiles</b>, aka
<code>build.ss</code>.
</p>

<p>
Specs are built.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">spec-build</span> spec settings)
  (<span style="color: #4f97d7; font-weight: bold;">match</span> spec
    ((<span style="color: #4f97d7;">?</span> string? modf)
     (gxc-compile modf <span style="color: #4f97d7;">#f</span> settings <span style="color: #4f97d7;">#t</span>))
    (<span style="color: #7590db;">[</span><span style="color: #4f97d7;">gxc:</span> modf . opts<span style="color: #7590db;">]</span>
     (gxc-compile modf opts settings <span style="color: #4f97d7;">#t</span>))
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">([gsc: modf . opts]</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;;  </span><span style="color: #2aa1ae; background-color: #292e34;">(gsc-compile modf opts settings))</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">([ssi: modf . submodules]</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;;  </span><span style="color: #2aa1ae; background-color: #292e34;">(for-each (cut build &lt;&gt; settings) submodules)</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;;  </span><span style="color: #2aa1ae; background-color: #292e34;">(compile-ssi modf '() settings))</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">([exe: modf . opts]</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;;  </span><span style="color: #2aa1ae; background-color: #292e34;">(compile-exe modf opts settings))</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">([static-exe: modf . opts]</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;;  </span><span style="color: #2aa1ae; background-color: #292e34;">(compile-static-exe modf opts settings))</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">([static-include: file]</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;;  </span><span style="color: #2aa1ae; background-color: #292e34;">(copy-static file settings))</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">([copy: file]</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;;  </span><span style="color: #2aa1ae; background-color: #292e34;">(copy-compiled file settings))</span>
    (<span style="color: #4f97d7; font-weight: bold;">else</span>
     (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"Bad buildspec"</span> spec))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #4f97d7;">package:</span> std/make
(<span style="color: #4f97d7; font-weight: bold;">import</span> ./mod ./gxc <span style="color: #4f97d7;">:std/srfi/1</span>)
(<span style="color: #4f97d7; font-weight: bold;">export</span> <span style="color: #4f97d7;">#t</span>)
<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">Build item spec</span>
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">spec-type</span> spec)
  (<span style="color: #4f97d7; font-weight: bold;">match</span> spec
    ((<span style="color: #4f97d7;">?</span> string? <span style="color: #4f97d7;">_</span>) <span style="color: #4f97d7;">gxc:</span>)
    (<span style="color: #7590db;">[</span>(<span style="color: #4f97d7;">?</span> keyword? type) . <span style="color: #4f97d7;">_</span><span style="color: #7590db;">]</span> type)
    (<span style="color: #4f97d7; font-weight: bold;">else</span> (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"Bad buildspec"</span> spec))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">spec-file</span> spec settings)
  (<span style="color: #4f97d7; font-weight: bold;">match</span> spec
    ((<span style="color: #4f97d7;">?</span> string? modf) (source-path modf <span style="color: #2d9574;">".ss"</span> settings))
    (<span style="color: #7590db;">[</span><span style="color: #4f97d7;">gxc:</span> modf . opts<span style="color: #7590db;">]</span> (source-path modf <span style="color: #2d9574;">".ss"</span> settings))
    (<span style="color: #7590db;">[</span><span style="color: #4f97d7;">gsc:</span> modf . opts<span style="color: #7590db;">]</span> (source-path modf <span style="color: #2d9574;">".scm"</span> settings))
    (<span style="color: #7590db;">[</span><span style="color: #4f97d7;">ssi:</span> modf . deps<span style="color: #7590db;">]</span> (source-path modf <span style="color: #2d9574;">".ssi"</span> settings))
    (<span style="color: #7590db;">[</span><span style="color: #4f97d7;">exe:</span> modf . opts<span style="color: #7590db;">]</span> (source-path modf <span style="color: #2d9574;">".ss"</span> settings))
    (<span style="color: #7590db;">[</span><span style="color: #4f97d7;">static-exe:</span> modf . opts<span style="color: #7590db;">]</span> (source-path modf <span style="color: #2d9574;">".ss"</span> settings))
    (<span style="color: #7590db;">[</span><span style="color: #4f97d7;">static-include:</span> file<span style="color: #7590db;">]</span> (static-file-path file settings))
    (<span style="color: #7590db;">[</span><span style="color: #4f97d7;">copy:</span> file<span style="color: #7590db;">]</span> file)
    (<span style="color: #4f97d7; font-weight: bold;">else</span>
     (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"Bad buildspec"</span> spec))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">spec-inputs</span> spec settings)
  <span style="color: #7590db;">[</span>(spec-file spec settings) (spec-extra-inputs spec settings) <span style="color: #4f97d7;">...</span><span style="color: #7590db;">]</span>)

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">spec-extra-inputs</span> spec settings)
  (<span style="color: #4f97d7; font-weight: bold;">match</span> spec
    (<span style="color: #7590db;">[</span><span style="color: #4f97d7;">gxc:</span> . <span style="color: #4f97d7;">_</span><span style="color: #7590db;">]</span> (pgetq <span style="color: #4f97d7;">extra-inputs:</span> (spec-plist spec) <span style="color: #7590db;">[]</span>))
    (<span style="color: #7590db;">[</span><span style="color: #4f97d7;">gsc:</span> . <span style="color: #4f97d7;">_</span><span style="color: #7590db;">]</span> (pgetq <span style="color: #4f97d7;">extra-inputs:</span> (spec-plist spec) <span style="color: #7590db;">[]</span>))
    (<span style="color: #7590db;">[</span><span style="color: #4f97d7;">ssi:</span> <span style="color: #4f97d7;">_</span> . submodules<span style="color: #7590db;">]</span> (append-map (<span style="color: #4f97d7; font-weight: bold;">cut</span> spec-inputs <span style="color: #4f97d7;">&lt;&gt;</span> settings) submodules))
    (<span style="color: #4f97d7;">_</span> <span style="color: #7590db;">[]</span>)))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">spec-plist</span> spec)
  (<span style="color: #4f97d7; font-weight: bold;">match</span> spec
    (<span style="color: #7590db;">[</span>(<span style="color: #4f97d7;">?</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> member <span style="color: #4f97d7;">&lt;&gt;</span> <span style="color: #4f97d7; font-weight: bold;">'</span>(<span style="color: #4f97d7;">gxc:</span> <span style="color: #4f97d7;">gsc:</span>))) <span style="color: #4f97d7;">_</span> <span style="color: #7590db;">[</span>plist <span style="color: #4f97d7;">...</span><span style="color: #7590db;">]</span> . <span style="color: #4f97d7;">_</span><span style="color: #7590db;">]</span> plist)
    (<span style="color: #4f97d7;">_</span> <span style="color: #7590db;">[]</span>)))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">spec-outputs</span> spec settings)
  (<span style="color: #4f97d7; font-weight: bold;">match</span> spec
    ((<span style="color: #4f97d7;">?</span> string? modf) (gxc-outputs modf <span style="color: #4f97d7;">#f</span> settings))
    (<span style="color: #7590db;">[</span><span style="color: #4f97d7;">gxc:</span> modf . opts<span style="color: #7590db;">]</span> (gxc-outputs modf opts settings))
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">([gsc: modf . opts] [(gsc-c-path modf settings)])</span>
    (<span style="color: #7590db;">[</span><span style="color: #4f97d7;">ssi:</span> modf . submodules<span style="color: #7590db;">]</span> <span style="color: #7590db;">[</span>(library-path modf <span style="color: #2d9574;">".ssi"</span> settings)
                               (append-map (<span style="color: #4f97d7; font-weight: bold;">cut</span> spec-outputs <span style="color: #4f97d7;">&lt;&gt;</span> settings) submodules) <span style="color: #4f97d7;">...</span><span style="color: #7590db;">]</span>)
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">([exe: modf . opts] [(library-path modf ".ssi" settings)</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;;                      </span><span style="color: #2aa1ae; background-color: #292e34;">(binary-path modf opts settings)])</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">([static-exe: modf . opts] [(binary-path modf opts settings)</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;;                            </span><span style="color: #2aa1ae; background-color: #292e34;">(static-path modf settings)])</span>
    (<span style="color: #7590db;">[</span><span style="color: #4f97d7;">static-include:</span> file<span style="color: #7590db;">]</span> <span style="color: #7590db;">[</span>(static-file-path file settings)<span style="color: #7590db;">]</span>)
    (<span style="color: #7590db;">[</span><span style="color: #4f97d7;">copy:</span> file<span style="color: #7590db;">]</span> <span style="color: #7590db;">[</span>(library-path file <span style="color: #4f97d7;">#f</span> settings)<span style="color: #7590db;">]</span>)
    (<span style="color: #4f97d7; font-weight: bold;">else</span> (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"Bad buildspec"</span> spec))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">spec-backgroundable?</span> spec)
  (<span style="color: #4f97d7; font-weight: bold;">case</span> (spec-type spec)
    ((<span style="color: #4f97d7;">gxc:</span>) (<span style="color: #4f97d7; font-weight: bold;">not</span> (pgetq <span style="color: #4f97d7;">foreground:</span> (spec-plist spec))))
    ((<span style="color: #4f97d7;">gsc:</span>) <span style="color: #4f97d7;">#t</span>)
    (<span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7;">#f</span>)))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">spec-build</span> spec settings)
  (<span style="color: #4f97d7; font-weight: bold;">match</span> spec
    ((<span style="color: #4f97d7;">?</span> string? modf)
     (gxc-compile modf <span style="color: #4f97d7;">#f</span> settings <span style="color: #4f97d7;">#t</span>))
    (<span style="color: #7590db;">[</span><span style="color: #4f97d7;">gxc:</span> modf . opts<span style="color: #7590db;">]</span>
     (gxc-compile modf opts settings <span style="color: #4f97d7;">#t</span>))
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">([gsc: modf . opts]</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;;  </span><span style="color: #2aa1ae; background-color: #292e34;">(gsc-compile modf opts settings))</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">([ssi: modf . submodules]</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;;  </span><span style="color: #2aa1ae; background-color: #292e34;">(for-each (cut build &lt;&gt; settings) submodules)</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;;  </span><span style="color: #2aa1ae; background-color: #292e34;">(compile-ssi modf '() settings))</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">([exe: modf . opts]</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;;  </span><span style="color: #2aa1ae; background-color: #292e34;">(compile-exe modf opts settings))</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">([static-exe: modf . opts]</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;;  </span><span style="color: #2aa1ae; background-color: #292e34;">(compile-static-exe modf opts settings))</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">([static-include: file]</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;;  </span><span style="color: #2aa1ae; background-color: #292e34;">(copy-static file settings))</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">([copy: file]</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;;  </span><span style="color: #2aa1ae; background-color: #292e34;">(copy-compiled file settings))</span>
    (<span style="color: #4f97d7; font-weight: bold;">else</span>
     (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"Bad buildspec"</span> spec))))
</pre>
</div>
</div>
</li>


<li><a id="orgd3979fc"></a><code>make/make</code>: The maker of makes<br />
<div class="outline-text-5" id="text-orgd3979fc">
<p>
We very much want build.ss to be minimal. This is where the middle meddling all
takes place.
</p>

<p>
We'll just simply experiment. We error if there is no input, and warn if the
output "fails".
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #4f97d7;">package:</span> std/make
(<span style="color: #4f97d7; font-weight: bold;">import</span> ./spec ./base ./settings)
(<span style="color: #4f97d7; font-weight: bold;">export</span> make)

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">make-spec</span> spec settings)
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">inputs</span> (spec-inputs spec settings))
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">outputs</span> (spec-outputs spec settings))

  (<span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #bc6ec5; font-weight: bold;">exists?</span> ((is inputs))
    (<span style="color: #4f97d7; font-weight: bold;">unless</span> (null? is)
      (<span style="color: #4f97d7; font-weight: bold;">unless</span> (file-exists? (car is))
        (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"Build Input file does not exist: "</span> (car is)))
      (exists? (cdr is))))

  (<span style="color: #4f97d7; font-weight: bold;">let</span> (res (spec-build spec settings))
    (<span style="color: #4f97d7; font-weight: bold;">begin0</span> res
      (message <span style="color: #2d9574;">"build result "</span> res <span style="color: #2d9574;">" for "</span> spec)
      (<span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #bc6ec5; font-weight: bold;">exists?</span> ((os outputs))
        (<span style="color: #4f97d7; font-weight: bold;">unless</span> (null? os) (<span style="color: #4f97d7; font-weight: bold;">unless</span> (file-exists? (car os))
                             (displayln <span style="color: #2d9574;">"\nBuild Output file does not exist: "</span> (car os)))
                (exists? (cdr os)))))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">make</span> build-spec . args)
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">settings</span> (<span style="color: #4f97d7; font-weight: bold;">apply</span> make-settings args))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #bc6ec5; font-weight: bold;">%make</span> ((s build-spec))
    (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">spec</span> (car s)) (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">rest</span> (cdr s))
    (make-spec spec settings) (<span style="color: #4f97d7; font-weight: bold;">unless</span> (null? rest) (%make rest))))
</pre>
</div>
</div>
</li>

<li><a id="org5d3febd"></a><code>/make/script</code>: A clone of up above.<br />
<div class="outline-text-5" id="text-org5d3febd">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">-*- Gerbil -*-</span>
<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">(C) vyzo at hackzen.org, me at drewc.ca</span>
<span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">package build script template</span>
<span style="color: #4f97d7;">package:</span> std/make
(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:std/make/make</span>
        <span style="color: #4f97d7;">:gerbil/gambit/misc</span>)

(<span style="color: #4f97d7; font-weight: bold;">export</span> defmake-script build-main)

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">build-main</span> args build-spec keys that-file)
  (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">srcdir</span> (path-normalize (path-directory that-file)))
  (<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">build</span>) (<span style="color: #4f97d7; font-weight: bold;">apply</span> make build-spec <span style="color: #4f97d7;">srcdir:</span> srcdir keys))
  (<span style="color: #4f97d7; font-weight: bold;">match</span> args
    (<span style="color: #7590db;">[</span><span style="color: #2d9574;">"meta"</span><span style="color: #7590db;">]</span> (write <span style="color: #4f97d7; font-weight: bold;">'</span>(<span style="color: #2d9574;">"spec"</span> <span style="color: #2d9574;">"compile"</span>)) (newline))
    (<span style="color: #7590db;">[</span><span style="color: #2d9574;">"spec"</span><span style="color: #7590db;">]</span> (pretty-print build-spec))
    (<span style="color: #7590db;">[</span><span style="color: #2d9574;">"compile"</span><span style="color: #7590db;">]</span> (build))
    (<span style="color: #7590db;">[]</span> (build))))

(<span style="color: #4f97d7; font-weight: bold;">defsyntax</span> (<span style="color: #7590db;">defmake-script</span> stx)
  (<span style="color: #4f97d7; font-weight: bold;">syntax-case</span> stx ()
    ((macro build-spec keys <span style="color: #4f97d7;">...</span>)
     (<span style="color: #4f97d7; font-weight: bold;">with-syntax*</span> ((<span style="color: #7590db;">@</span>this-script (stx-identifier <span style="color: #4f97d7; font-weight: bold;">#'</span>macro <span style="color: #4f97d7; font-weight: bold;">'</span>this-source-file))
                    (+this-source-file+ (<span style="color: #4f97d7; font-weight: bold;">syntax/loc</span> stx (<span style="color: #7590db;">@</span>this-script)))
                    (<span style="color: #7590db;">@</span>main        (stx-identifier <span style="color: #4f97d7; font-weight: bold;">#'</span>macro <span style="color: #4f97d7; font-weight: bold;">'</span>main)))
       <span style="color: #4f97d7; font-weight: bold;">#'</span>(def (<span style="color: #7590db;">@</span>main . args)
           (build-main args build-spec <span style="color: #7590db;">[</span>keys <span style="color: #4f97d7;">...</span><span style="color: #7590db;">]</span> +this-source-file+))))))
</pre>
</div>
</div>
</li>
<li><a id="org357c6f2"></a><code>build.ss</code>: The makefile for making makefiles.<br />
<div class="outline-text-5" id="text-org357c6f2">
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:gerbil/expander</span> <span style="color: #4f97d7;">:std/misc/path</span> )

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">this-file</span> (this-source-file))

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">srcdir</span> (path-directory this-file))

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">build-specs</span>
  <span style="color: #4f97d7; font-weight: bold;">'</span>(<span style="color: #2d9574;">"make/base"</span> <span style="color: #2d9574;">"make/settings"</span> <span style="color: #2d9574;">"make/expander-module"</span> <span style="color: #2d9574;">"make/mod"</span>
    <span style="color: #2d9574;">"make/gsc"</span> <span style="color: #2d9574;">"make/gxc"</span> <span style="color: #2d9574;">"make/spec"</span> <span style="color: #2d9574;">"make/make"</span> <span style="color: #2d9574;">"make/script"</span>))

(gx<span style="color: #4f97d7;">#</span>import-module (path-expand <span style="color: #2d9574;">"make/bootstrap.ss"</span> srcdir) <span style="color: #4f97d7;">#t</span> <span style="color: #4f97d7;">#t</span>)

((<span style="color: #4f97d7; font-weight: bold;">eval</span> <span style="color: #4f97d7; font-weight: bold;">'</span>std/make/bootstrap<span style="color: #4f97d7;">#</span>bootstrap-make) build-specs srcdir)
</pre>
</div>
</div>
</li>
</ul>
</div>


<div id="outline-container-org72d8d62" class="outline-3">
<h3 id="org72d8d62">Step 4: Test the new <code>make/script</code></h3>
<div class="outline-text-3" id="text-org72d8d62">
<p>
This is just simple. There's a lot more to come but prerelease means only this.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:std/make/script</span>)
(defmake-script <span style="color: #7590db;">[</span><span style="color: #2d9574;">"hello"</span><span style="color: #7590db;">]</span> <span style="color: #4f97d7;">verbose:</span> 10)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">rm ~/.gerbil/lib/drewc/hello*
~/src/gerbil-build/test/build.ss
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">... compile-file hello
compile /home/user/src/gerbil-build/test/hello.ss
compile drewc/hello 
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">[...] </span>
compile ~/.gerbil/lib/drewc/hello__0.scm
invoke gsc <span style="color: #4f97d7;">(</span>gsc -:i8,f8,-8,t8 -debug-environments ~/.gerbil/lib/drewc/hello__0.scm<span style="color: #4f97d7;">)</span>
copy static module ~/.gerbil/lib/drewc/hello__0.scm =&gt; ~/.gerbil/lib/static/drewc__hello.scm
compile ~/.gerbil/lib/drewc/hello__rt.scm
invoke gsc <span style="color: #4f97d7;">(</span>gsc -:i8,f8,-8,t8 -debug-environments ~/.gerbil/lib/drewc/hello__rt.scm<span style="color: #4f97d7;">)</span>
compile ~/.gerbil/lib/drewc/hello.ssi
generate typedecl drewc/hello#hello
compile ~/.gerbil/lib/drewc/hello.ssxi.ss
build result <span style="color: #2aa1ae; background-color: #292e34;">#</span><span style="color: #2aa1ae; background-color: #292e34;">!void for hello</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:drewc/hello</span> <span style="color: #4f97d7;">:std/test</span>)

(check (drewc/hello<span style="color: #4f97d7;">#</span>hello) <span style="color: #4f97d7;">=&gt;</span> <span style="color: #2d9574;">"Hello World"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">gxi -e <span style="color: #2d9574;">'(load "~/src/gerbil-build/test/make-script.ss")'</span>
</pre>
</div>
<p>
1
</p>
<pre class="example">
Hello World
</pre>
</div>
</div>

<div id="outline-container-orga1e2be7" class="outline-3">
<h3 id="orga1e2be7">Step 5: Publish Documentation</h3>
<div class="outline-text-3" id="text-orga1e2be7">
<p>
Literate programming involves <b>weaving</b> out documentation as well and <b>tangling</b>
source code.
</p>

<p>
As of "right now" (git commit: <code>d0ac46b370dbfa915b65a3c024eb63ac27d1024e</code>),
everything is contained in a <code>README.org</code> which, to be quite honest, is not
necessarily the correct place to design, implement and document an entire
project.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-orged8d92a" class="outline-2">
<h2 id="orged8d92a">Appendicitis</h2>
<div class="outline-text-2" id="text-orged8d92a">
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7;">:gerbil/compiler</span> <span style="color: #4f97d7;">:std/misc/path</span> <span style="color: #4f97d7;">:std/misc/list</span>
      <span style="color: #4f97d7;">:std/misc/concurrent-plan</span>)

 <span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">Settings: see details in doc/reference/make.md</span>
 (<span style="color: #4f97d7; font-weight: bold;">defstruct</span> <span style="color: #ce537a; font-weight: bold;">settings</span>
   (srcdir libdir bindir package force optimize debug static static-debug verbose build-deps
    libdir-prefix parallelize)
   <span style="color: #4f97d7;">transparent:</span> <span style="color: #4f97d7;">#t</span> <span style="color: #4f97d7;">constructor:</span> <span style="color: #4f97d7;">:init!</span>)

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">current-make-settings</span> (make-parameter <span style="color: #4f97d7;">#f</span>))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">gerbil-build-cores</span>)
  (with-catch (<span style="color: #4f97d7; font-weight: bold;">lambda</span> (<span style="color: #4f97d7;">_</span>) (<span style="color: #4f97d7;">##</span>cpu-count)) (<span style="color: #4f97d7; font-weight: bold;">lambda</span> () (string-&gt;number (getenv <span style="color: #2d9574;">"GERBIL_BUILD_CORES"</span>)))))

(<span style="color: #4f97d7; font-weight: bold;">defmethod</span> <span style="color: #7590db;">{</span><span style="color: #4f97d7;">:init!</span> settings<span style="color: #7590db;">}</span>
 (<span style="color: #4f97d7; font-weight: bold;">lambda</span> (self
     <span style="color: #4f97d7;">srcdir:</span> (srcdir<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">libdir:</span> (libdir<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">bindir:</span> (bindir<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">package:</span> (package<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">force:</span> (force? <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">optimize:</span> (optimize <span style="color: #4f97d7;">#t</span>) <span style="color: #4f97d7;">debug:</span> (debug <span style="color: #4f97d7; font-weight: bold;">'</span>env)
     <span style="color: #4f97d7;">static:</span> (static <span style="color: #4f97d7;">#t</span>) <span style="color: #4f97d7;">static-debug:</span> (static-debug <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">verbose:</span> (verbose <span style="color: #4f97d7;">#f</span>) <span style="color: #4f97d7;">build-deps:</span> (build-deps<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#f</span>)
     <span style="color: #4f97d7;">parallelize:</span> (parallelize<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#t</span>))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">gerbil-path</span> (getenv <span style="color: #2d9574;">"GERBIL_PATH"</span> <span style="color: #2d9574;">"~/.gerbil"</span>))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">srcdir</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> srcdir<span style="color: #4f97d7;">_</span> (<span style="color: #4f97d7; font-weight: bold;">error</span> <span style="color: #2d9574;">"srcdir must be specified"</span>)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">libdir</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> libdir<span style="color: #4f97d7;">_</span> (path-expand <span style="color: #2d9574;">"lib"</span> gerbil-path)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">bindir</span> (<span style="color: #4f97d7; font-weight: bold;">or</span> bindir<span style="color: #4f97d7;">_</span> (path-expand <span style="color: #2d9574;">"bin"</span> gerbil-path)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">package</span> (<span style="color: #4f97d7; font-weight: bold;">and</span> package<span style="color: #4f97d7;">_</span> (<span style="color: #4f97d7; font-weight: bold;">if</span> (symbol? package<span style="color: #4f97d7;">_</span>) (symbol-&gt;string package<span style="color: #4f97d7;">_</span>) package<span style="color: #4f97d7;">_</span>)))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">libdir-prefix</span> (<span style="color: #4f97d7; font-weight: bold;">if</span> package (path-expand package libdir) libdir))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">build-deps</span> (path-expand (<span style="color: #4f97d7; font-weight: bold;">or</span> build-deps<span style="color: #4f97d7;">_</span> <span style="color: #2d9574;">"build-deps"</span>) srcdir))
   (<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">parallelize</span> (<span style="color: #4f97d7; font-weight: bold;">if</span> (eq? parallelize<span style="color: #4f97d7;">_</span> <span style="color: #4f97d7;">#t</span>) (gerbil-build-cores) (<span style="color: #4f97d7; font-weight: bold;">or</span> parallelize<span style="color: #4f97d7;">_</span> 0)))
   (struct-instance-init!
     self
     srcdir libdir bindir package force? optimize debug static static-debug verbose build-deps
     libdir-prefix parallelize))
 <span style="color: #4f97d7;">rebind:</span> <span style="color: #4f97d7;">#t</span>)

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">source-path</span> mod ext settings)
  (path-expand (path-default-extension mod ext) (settings-srcdir settings)))

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">mod-modules</span> (make-hash-table)) <span style="color: #2aa1ae; background-color: #292e34;">;;; </span><span style="color: #2aa1ae; background-color: #292e34;">cache</span>
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">mod-module</span> mod (settings (current-make-settings)) (reload? <span style="color: #4f97d7;">#f</span>))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> (v (hash-ref mod-modules mod (void)))
    (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">and</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> (void? v)) (<span style="color: #4f97d7; font-weight: bold;">not</span> reload?)) v
        (<span style="color: #4f97d7; font-weight: bold;">let*</span> ((src (source-path mod <span style="color: #2d9574;">".ss"</span> settings))
               (m (<span style="color: #4f97d7; font-weight: bold;">and</span> (file-exists? src) (gx<span style="color: #4f97d7;">#</span>import-module src reload?))))
          (<span style="color: #4f97d7; font-weight: bold;">begin0</span> m (hash-put! mod-modules mod m))))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-id</span> gx<span style="color: #4f97d7;">#</span>expander-context-id)
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-id-set!</span> gx<span style="color: #4f97d7;">#</span>expander-context-id-set!)

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">mod-core-modules</span> (make-hash-table))
(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">mod-core-module</span> mod (settings (current-make-settings)) (reload? <span style="color: #4f97d7;">#f</span>))
  <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt; (values prelude module-id module-ns body)</span>
  (<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">mrm</span>)
    (<span style="color: #4f97d7; font-weight: bold;">let</span> (v (<span style="color: #4f97d7; font-weight: bold;">if</span> reload? (void) (hash-ref mod-core-modules mod (void))))
      (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> (void? v)) v
          (<span style="color: #4f97d7; font-weight: bold;">let*</span> ((src (path-force-extension mod <span style="color: #2d9574;">".ss"</span>))
                 (rm (<span style="color: #4f97d7; font-weight: bold;">and</span> (file-exists? src) (gx<span style="color: #4f97d7;">#</span>core-read-module src))))
            (<span style="color: #4f97d7; font-weight: bold;">begin0</span> rm (hash-put! mod-core-modules mod rm))))))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> ((srcdir (path-normalize (settings-srcdir settings)))
        (cd (path-normalize (current-directory))))
    (<span style="color: #4f97d7; font-weight: bold;">if</span> (equal? srcdir cd) (mrm)
        (<span style="color: #4f97d7; font-weight: bold;">parameterize</span> ((current-directory srcdir))
          (mrm)))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">core-module-prelude</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> values-ref <span style="color: #4f97d7;">&lt;&gt;</span> 0))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">core-module-id</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> values-ref <span style="color: #4f97d7;">&lt;&gt;</span> 1))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">core-module-ns</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> values-ref <span style="color: #4f97d7;">&lt;&gt;</span> 2))
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">core-module-code</span> (<span style="color: #4f97d7; font-weight: bold;">cut</span> values-ref <span style="color: #4f97d7;">&lt;&gt;</span> 3))

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">mod-module-id</span> mod (settings (current-make-settings)))
  (<span style="color: #4f97d7; font-weight: bold;">let</span> ((mcm (mod-core-module mod settings))
        (sp (settings-package settings)))
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If the core module package is the same as the mod that means we could not</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">find a package.</span>
    (<span style="color: #4f97d7; font-weight: bold;">if</span> (equal? mod (symbol-&gt;string (core-module-id mcm)))
      <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">If we do not have a toplevel package we are the package.</span>
      (<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #4f97d7; font-weight: bold;">not</span> sp) (string-&gt;symbol mod)
          <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">otherwise add it as a super and return</span>
          (string-&gt;symbol (path-expand mod sp)))
      <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">Otherwise the mrm has the right id</span>
      (core-module-id mcm))))

(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-ns</span> gx<span style="color: #4f97d7;">#</span>module-context-ns)
(<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">module-ns-set!</span> gx<span style="color: #4f97d7;">#</span>module-context-ns-set!)

(<span style="color: #4f97d7; font-weight: bold;">def</span> (<span style="color: #bc6ec5; font-weight: bold;">prep-module-code</span> module code)
  (gx<span style="color: #4f97d7;">#</span>core-quote-syntax (gx<span style="color: #4f97d7;">#</span>core-cons <span style="color: #4f97d7; font-weight: bold;">'</span><span style="color: #4f97d7;">%#begin</span> code)
 (gx<span style="color: #4f97d7;">#</span>module-context-path module) module <span style="color: #7590db;">[]</span>))
</pre>
</div>


<p>
1
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2020-07-28 Tue 19:10</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
